<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Hyphon Chat</title>
  <style>
    body {font-family:sans-serif;margin:0;}
    header {position:fixed;top:0;width:100%;background:#333;padding:10px;z-index:10;}
    header div {display:flex;gap:10px;}
    header button {
      background:linear-gradient(135deg,#f1c40f,#e67e22);
      border:none;color:#fff;padding:6px 12px;
      border-radius:6px;cursor:pointer;font-weight:600;
    }
    #chatUI {margin-top:60px;}
    #chat {height:400px;overflow-y:auto;border:1px solid #ccc;padding:10px;}
    textarea {width:100%;height:50px;}
    .modal {display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);}
    .modalContent {background:#fff;padding:20px;margin:10% auto;width:300px;border-radius:8px;}
  </style>
</head>
<body>

<!-- Startup Screen -->
<div id="startupScreen">
  <h1>Welcome to Hyphon Chat</h1>
  <div>
    <button style="background:linear-gradient(135deg,#f1c40f,#e67e22);color:#fff;font-weight:600;"
      onclick="accUI('Create')">Sign Up for Free</button>
    <div style="margin-top:10px;">
      <button style="background:linear-gradient(135deg,#f1c40f,#e67e22);color:#fff;font-weight:600;"
        onclick="accUI('Login')">Log In</button>
    </div>
  </div>
</div>

<header>
  <div>
    <button id="accBtn" onclick="openAcc()">Account</button>
    <button id="chatsBtn" onclick="opn('chatsModal')">My Chats</button>
    <button id="newChatBtn" onclick="opn('newModal')">New Chat</button>
    <button id="leaveBtn" onclick="leaveChat()">Leave Chat</button>
    <button id="dmsBtn" onclick="opn('dmsModal')">DMs</button>
    <button id="friendBtn" onclick="opn('friendReqModal')">Friends</button>
    <!-- NEW Chat Settings button (hidden by default, only shows if user owns chat) -->
    <button id="chatSettingsBtn" style="display:none;" onclick="opn('chatSettingsModal')">Chat Settings</button>
  </div>
</header>

<div id="chatUI">
  <div id="chatContainer">
    <div id="chat"></div>
    <textarea id="msg" placeholder="Type..."></textarea>
    <button id="sendBtn" onclick="sendMsg()">Send</button>
    <div id="typingDiv" style="font-size:12px;color:#aaa;margin-top:4px;"></div>
  </div>
</div>

<!-- Modals -->
<div id="accModal" class="modal"><div class="modalContent" id="accBox"></div></div>
<div id="chatsModal" class="modal"><div class="modalContent"><h3>My Chats</h3><div id="chatList"></div><button onclick="cls('chatsModal')">X</button></div></div>
<div id="newModal" class="modal"><div class="modalContent"><button onclick="mkChat()">Create Chat</button><button onclick="jnChat()">Join Chat</button><button onclick="cls('newModal')">X</button></div></div>
<div id="mkModal" class="modal"><div class="modalContent"><input id="mkName" placeholder="Chat name"><button onclick="subMk()">Go</button><button onclick="cls('mkModal')">X</button></div></div>
<div id="jnModal" class="modal"><div class="modalContent"><input id="jnCode" placeholder="Chat code"><button onclick="subJn()">Go</button><button onclick="cls('jnModal')">X</button></div></div>
<div id="friendReqModal" class="modal"><div class="modalContent"><h3>Friend Requests</h3><div id="friendRequests"></div><button onclick="cls('friendReqModal')">X</button></div></div>
<div id="dmsModal" class="modal"><div class="modalContent"><h3>DMs</h3><div id="dmsList"></div><button onclick="cls('dmsModal')">X</button></div></div>

<!-- NEW Chat Settings Modal -->
<div id="chatSettingsModal" class="modal">
  <div class="modalContent">
    <h3>Chat Settings</h3>
    <p><b>Invite Code:</b> <span id="chatInviteCode">N/A</span></p>
    <label>Slowmode (sec): <input id="slowmodeInput" type="number" min="0" value="0"></label>
    <button onclick="applySlowmode()">Apply</button>
    <h4>Manage Members</h4>
    <div id="memberList"></div>
    <button onclick="cls('chatSettingsModal')">Close</button>
  </div>
</div>

<!-- BIG SPLIT MARKER (END OF FIRST HALF) -->
<!-- ======================== END OF FIRST HALF ======================== -->
<!-- ======================== START OF SECOND HALF ======================== -->

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script>
const fb={apiKey:"AIzaSyCSh6K8e_CAswGyYuIvgMVKZ3T8b5gGKFU",authDomain:"hyphonchat.firebaseapp.com",databaseURL:"https://hyphonchat-default-rtdb.firebaseio.com",projectId:"hyphonchat",storageBucket:"hyphonchat.firebasestorage.app",messagingSenderId:"172774813412",appId:"1:172774813412:web:8d307b6a170bf270cfc6f1"};
firebase.initializeApp(fb);
const db=firebase.database();

let currentUser=null;
let currentChat=null;
let currentChatOwner=null;
let slowmode=0;
let lastMessageTime=0;

// Basic modal helpers
function opn(id){document.getElementById(id).style.display='block';}
function cls(id){document.getElementById(id).style.display='none';}

// ================= ACCOUNT =================
function accUI(type){
  if(type==="Create"){
    document.getElementById("accBox").innerHTML=`<h3>Create Account</h3>
      <input id="newUser" placeholder="Username"><br>
      <button onclick="createAcc()">Go</button>
      <button onclick="cls('accModal')">Cancel</button>`;
    opn("accModal");
  }else if(type==="Login"){
    document.getElementById("accBox").innerHTML=`<h3>Login</h3>
      <input id="loginUser" placeholder="Username"><br>
      <button onclick="loginAcc()">Go</button>
      <button onclick="cls('accModal')">Cancel</button>`;
    opn("accModal");
  }
}
function openAcc(){ accUI("Login"); }
function createAcc(){
  let u=document.getElementById("newUser").value.trim();
  if(!u) return;
  currentUser=u;
  localStorage.setItem("user",u);
  cls("accModal");
  document.getElementById("startupScreen").style.display="none";
}
function loginAcc(){
  let u=document.getElementById("loginUser").value.trim();
  if(!u) return;
  currentUser=u;
  localStorage.setItem("user",u);
  cls("accModal");
  document.getElementById("startupScreen").style.display="none";
}
if(localStorage.getItem("user")){
  currentUser=localStorage.getItem("user");
  document.getElementById("startupScreen").style.display="none";
}

// ================= CHATS =================
function mkChat(){ cls("newModal"); opn("mkModal"); }
function subMk(){
  let name=document.getElementById("mkName").value.trim();
  if(!name) return;
  let code=Math.random().toString(36).substr(2,6);
  db.ref("chats/"+code).set({
    name:name,
    owner:currentUser,
    members:{[currentUser]:true},
    slowmode:0
  });
  joinChat(code,true);
  cls("mkModal");
}
function jnChat(){ cls("newModal"); opn("jnModal"); }
function subJn(){
  let code=document.getElementById("jnCode").value.trim();
  if(!code) return;
  joinChat(code,false);
  cls("jnModal");
}
function joinChat(code,isOwner){
  db.ref("chats/"+code).once("value",snap=>{
    if(snap.exists()){
      let chat=snap.val();
      currentChat=code;
      currentChatOwner=chat.owner;
      slowmode=chat.slowmode||0;
      db.ref("chats/"+code+"/members/"+currentUser).set(true);
      document.getElementById("chatInviteCode").innerText=code;
      // Owner button
      if(currentUser===currentChatOwner){
        document.getElementById("chatSettingsBtn").style.display="inline-block";
      }else{
        document.getElementById("chatSettingsBtn").style.display="none";
      }
      loadChat(code);
    }
  });
}
function leaveChat(){
  if(!currentChat) return;
  db.ref("chats/"+currentChat+"/members/"+currentUser).remove();
  currentChat=null;
  currentChatOwner=null;
  document.getElementById("chat").innerHTML="";
  document.getElementById("chatSettingsBtn").style.display="none";
}
function loadChat(code){
  document.getElementById("chat").innerHTML="";
  db.ref("messages/"+code).off();
  db.ref("messages/"+code).on("child_added",snap=>{
    let m=snap.val();
    let div=document.createElement("div");
    div.innerHTML=`<b>${m.user}:</b> ${m.text}`;
    document.getElementById("chat").appendChild(div);
    document.getElementById("chat").scrollTop=document.getElementById("chat").scrollHeight;
  });
}

// ================= MESSAGES =================
function sendMsg(){
  if(!currentChat||!currentUser) return;
  let now=Date.now();
  if(slowmode>0 && now-lastMessageTime<slowmode*1000){
    alert("Slowmode enabled. Please wait.");
    return;
  }
  let txt=document.getElementById("msg").value.trim();
  if(!txt) return;
  db.ref("messages/"+currentChat).push({user:currentUser,text:txt});
  document.getElementById("msg").value="";
  lastMessageTime=now;
}

// ================= CHAT SETTINGS =================
function applySlowmode(){
  let val=parseInt(document.getElementById("slowmodeInput").value)||0;
  if(currentUser!==currentChatOwner) return;
  db.ref("chats/"+currentChat+"/slowmode").set(val);
  slowmode=val;
  alert("Slowmode updated to "+val+" seconds.");
}
function loadMembers(){
  if(!currentChat) return;
  let box=document.getElementById("memberList");
  box.innerHTML="";
  db.ref("chats/"+currentChat+"/members").once("value",snap=>{
    snap.forEach(child=>{
      let user=child.key;
      let div=document.createElement("div");
      div.textContent=user;
      if(user!==currentUser && currentUser===currentChatOwner){
        let kickBtn=document.createElement("button");
        kickBtn.textContent="Kick";
        kickBtn.onclick=()=>kickUser(user);
        div.appendChild(kickBtn);
      }
      box.appendChild(div);
    });
  });
}
function kickUser(u){
  db.ref("chats/"+currentChat+"/members/"+u).remove();
  alert(u+" has been removed.");
}
document.getElementById("chatSettingsBtn").addEventListener("click",loadMembers);
</script>
</body>
</html>
