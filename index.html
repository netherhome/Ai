<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Hyphon Chat</title>
<style>
body {
  margin:0;
  font-family:sans-serif;
  background:#111;
  color:#fff;
}
header {
  position:fixed;
  top:0;
  width:100%;
  background:#222;
  padding:10px;
  display:flex;
  gap:10px;
  z-index:1000;
}
header button {
  background:linear-gradient(135deg,#f1c40f,#e67e22);
  border:none;
  padding:8px 14px;
  border-radius:8px;
  color:#fff;
  font-weight:bold;
  cursor:pointer;
}
#chatUI {
  margin-top:70px;
  padding:10px;
}
#chat {
  max-height:400px;
  overflow-y:auto;
  padding:10px;
  background:#1a1a1a;
  border-radius:10px;
  margin-bottom:10px;
  scroll-behavior:smooth;
}
.msg {
  margin:6px 0;
  padding:8px 12px;
  border-radius:12px;
  display:inline-block;
  max-width:50%;
  word-wrap:break-word;
}
.msg.me {
  background:#f39c12;
  float:right;
  clear:both;
}
.msg.other {
  background:#3498db;
  float:left;
  clear:both;
}
.msgHeader {
  display:flex;
  align-items:center;
  margin-bottom:3px;
}
.msgHeader img {
  width:24px;
  height:24px;
  border-radius:50%;
  margin-right:6px;
}
.msgHeader span {
  font-weight:bold;
  font-size:12px;
}
textarea#msg {
  width:calc(100% - 90px);
  height:40px;
  border-radius:8px;
  border:none;
  padding:8px;
  font-weight:bold;
  resize:none;
}
#sendBtn {
  background:linear-gradient(135deg,#e67e22,#d35400);
  border:none;
  padding:10px 18px;
  border-radius:8px;
  color:#fff;
  font-weight:bold;
  cursor:pointer;
}
.modal {
  display:none;
  position:fixed;
  top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0.7);
  z-index:2000;
}
.modalContent {
  background:linear-gradient(135deg,#2980b9,#2c3e50);
  margin:10% auto;
  padding:20px;
  border-radius:10px;
  width:300px;
  color:#fff;
}
#startupScreen {
  position:fixed;
  top:0;left:0;width:100%;height:100%;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  background:linear-gradient(135deg,#2980b9,#2c3e50);
  z-index:5000;
}
#startupScreen h1 {
  font-size:28px;
  margin-bottom:20px;
}
</style>
</head>
<body>

<!-- Startup Screen -->
<div id="startupScreen">
  <h1>Welcome to Hyphon Chat</h1>
  <div>
    <button style="background:linear-gradient(135deg,#f1c40f,#e67e22);color:#fff;font-weight:600;"
      onclick="accUI('Create')">Sign Up for Free</button>
    <div style="margin-top:10px;">
      <button style="background:linear-gradient(135deg,#f1c40f,#e67e22);color:#fff;font-weight:600;"
        onclick="accUI('Login')">Already have an account? Log in</button>
    </div>
  </div>
</div>

<header>
  <button id="accBtn">Account</button>
  <button id="chatsBtn">My Chats</button>
  <button id="newChatBtn">New Chat</button>
  <button id="leaveBtn">Leave Chat</button>
  <button id="dmsBtn">DMs</button>
  <button id="chatSettingsBtn" style="display:none;">Chat Settings</button>
</header>

<div id="chatUI">
  <div id="chatContainer">
    <div id="chat"></div>
    <textarea id="msg" placeholder="Type..."></textarea>
    <button id="sendBtn">Send</button>
    <div id="typingDiv" style="font-size:12px;color:#aaa;margin-top:4px;"></div>
  </div>
</div>

<!-- Modals -->
<div id="accModal" class="modal"><div class="modalContent" id="accBox"></div></div>
<div id="chatsModal" class="modal"><div class="modalContent"><h3>My Chats</h3><div id="chatList"></div><button onclick="cls('chatsModal')">X</button></div></div>
<div id="newModal" class="modal"><div class="modalContent"><button onclick="mkChat()">Create Chat</button><button onclick="jnChat()">Join Chat</button><button onclick="cls('newModal')">X</button></div></div>
<div id="mkModal" class="modal"><div class="modalContent"><input id="mkName" placeholder="Chat name"><button onclick="subMk()">Go</button><button onclick="cls('mkModal')">X</button></div></div>
<div id="jnModal" class="modal"><div class="modalContent"><input id="jnCode" placeholder="Chat code"><button onclick="subJn()">Go</button><button onclick="cls('jnModal')">X</button></div></div>
<div id="friendReqModal" class="modal"><div class="modalContent"><h3>Friend Requests</h3><div id="friendRequests"></div><button onclick="cls('friendReqModal')">X</button></div></div>
<div id="dmsModal" class="modal"><div class="modalContent"><h3>DMs</h3><div id="dmsList"></div><button onclick="cls('dmsModal')">X</button></div></div>

<!-- Chat Settings Modal -->
<div id="chatSettingsModal" class="modal">
  <div class="modalContent">
    <h3>Chat Settings</h3>
    <p><b>Invite Code:</b> <span id="chatInviteCode"></span></p>
    <label>Slowmode (seconds): <input id="slowmodeInput" type="number" min="0"></label>
    <button onclick="setSlowmode()">Set Slowmode</button>
    <h4>Ban / Kick User</h4>
    <input id="banUserInput" placeholder="Username">
    <button onclick="banUser()">Ban</button>
    <button onclick="kickUser()">Kick</button>
    <button onclick="cls('chatSettingsModal')">X</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script>
// Firebase
const fb={apiKey:"AIzaSyCSh6K8e_CAswGyYuIvgMVKZ3T8b5gGKFU",authDomain:"hyphonchat.firebaseapp.com",databaseURL:"https://hyphonchat-default-rtdb.firebaseio.com",projectId:"hyphonchat",storageBucket:"hyphonchat.firebasestorage.app",messagingSenderId:"172774813412",appId:"1:172774813412:web:8d307b6a170bf270cfc6f1"};
firebase.initializeApp(fb);
const db=firebase.database();

let curUser=null;
let curChat=null;
let slowmode=0;
let lastMsgTime=0;

// Utilities
function shw(id){document.getElementById(id).style.display="block";}
function cls(id){document.getElementById(id).style.display="none";}

// Account UI
function accUI(type){
  document.getElementById("startupScreen").style.display="none";
  const box=document.getElementById("accBox");
  if(type==="Create"){
    box.innerHTML='<h3>Create Account</h3><input id="newUser" placeholder="Username"><br><button onclick="createAcc()">Go</button>';
  }else if(type==="Login"){
    box.innerHTML='<h3>Login</h3><input id="oldUser" placeholder="Username"><br><button onclick="loginAcc()">Go</button>';
  }
  shw("accModal");
}

function createAcc(){
  const u=document.getElementById("newUser").value.trim();
  if(!u) return;
  curUser=u;
  db.ref("users/"+u).set({pfp:"https://th.bing.com/th/id/OIP.Xx93W3aTtFensmWsSFuDYAHaHa?w=202&h=202&c=7&r=0&o=7&dpr=1.3&pid=1.7&rm=3"});
  cls("accModal");
}
function loginAcc(){
  const u=document.getElementById("oldUser").value.trim();
  if(!u) return;
  curUser=u;
  cls("accModal");
}
// =========================
// PART 2 STARTS HERE
// =========================

// New Chat
function mkChat(){
  cls("newModal");shw("mkModal");
}
function subMk(){
  const name=document.getElementById("mkName").value.trim();
  if(!name||!curUser) return;
  const code=Math.random().toString(36).substr(2,6);
  curChat=code;
  db.ref("chats/"+code).set({name:name,owner:curUser});
  db.ref("chats/"+code+"/members/"+curUser).set(true);
  db.ref("chats/"+code+"/msgs").push({sys:`[${code}] ${curUser} Joined`});
  loadChat(code);
  cls("mkModal");
}

function jnChat(){
  cls("newModal");shw("jnModal");
}
function subJn(){
  const code=document.getElementById("jnCode").value.trim();
  if(!code) return;
  curChat=code;
  db.ref("chats/"+code+"/members/"+curUser).set(true);
  loadChat(code);
  cls("jnModal");
}

// Load chat
function loadChat(code){
  document.getElementById("chat").innerHTML="";
  db.ref("chats/"+code+"/owner").once("value").then(s=>{
    if(s.val()===curUser){
      document.getElementById("chatSettingsBtn").style.display="inline-block";
      document.getElementById("chatInviteCode").innerText=code;
    }else{
      document.getElementById("chatSettingsBtn").style.display="none";
    }
  });
  db.ref("chats/"+code+"/msgs").on("child_added",snap=>{
    const m=snap.val();
    addMsg(m);
  });
}

// Add message
function addMsg(m){
  const c=document.getElementById("chat");
  let div=document.createElement("div");
  if(m.sys){
    div.innerHTML="<i>"+m.sys+"</i>";
  }else{
    const who=m.user;
    const msg=document.createElement("div");
    msg.className="msg "+(who===curUser?"me":"other");
    let header=document.createElement("div");
    header.className="msgHeader";
    let img=document.createElement("img");
    img.src=m.pfp||"https://th.bing.com/th/id/OIP.Xx93W3aTtFensmWsSFuDYAHaHa?w=202&h=202&c=7&r=0&o=7&dpr=1.3&pid=1.7&rm=3";
    let uname=document.createElement("span");
    uname.innerText=who;
    if(curChat&&m.user){
      db.ref("chats/"+curChat+"/owner").once("value").then(s=>{
        if(s.val()===who) uname.style.fontWeight="bold";
      });
    }
    header.appendChild(img);
    header.appendChild(uname);
    msg.appendChild(header);
    let txt=document.createElement("div");
    txt.innerText=m.txt;
    msg.appendChild(txt);
    div.appendChild(msg);
  }
  c.appendChild(div);
  c.scrollTop=c.scrollHeight;
}

// Send
document.getElementById("sendBtn").onclick=function(){
  const now=Date.now();
  if(slowmode>0 && now-lastMsgTime<slowmode*1000){
    alert(`Slowmode is on! Please wait ${Math.ceil((slowmode*1000-(now-lastMsgTime))/1000)}s`);
    return;
  }
  sendMessage();
  lastMsgTime=now;
};
function sendMessage(){
  const t=document.getElementById("msg").value.trim();
  if(!t||!curUser||!curChat) return;
  db.ref("users/"+curUser).once("value").then(s=>{
    const pfp=(s.val()&&s.val().pfp)?s.val().pfp:"https://th.bing.com/th/id/OIP.Xx93W3aTtFensmWsSFuDYAHaHa?w=202&h=202&c=7&r=0&o=7&dpr=1.3&pid=1.7&rm=3";
    db.ref("chats/"+curChat+"/msgs").push({user:curUser,txt:t,pfp:pfp});
    document.getElementById("msg").value="";
  });
}

// Chat settings
function setSlowmode(){
  const val=parseInt(document.getElementById("slowmodeInput").value);
  if(!isNaN(val)&&val>=0){
    slowmode=val;
    alert("Slowmode set to "+val+" seconds");
  }
}
function banUser(){
  const user=document.getElementById("banUserInput").value.trim();
  if(user){
    db.ref("chats/"+curChat+"/banned/"+user).set(true);
    alert(user+" banned!");
  }
}
function kickUser(){
  const user=document.getElementById("banUserInput").value.trim();
  if(user){
    db.ref("chats/"+curChat+"/members/"+user).remove();
    alert(user+" kicked!");
  }
}

// Buttons
document.getElementById("accBtn").onclick=function(){accUI("Login");};
document.getElementById("newChatBtn").onclick=function(){shw("newModal");};
document.getElementById("chatsBtn").onclick=function(){shw("chatsModal");};
document.getElementById("leaveBtn").onclick=function(){
  if(curChat){
    db.ref("chats/"+curChat+"/members/"+curUser).remove();
    curChat=null;
    document.getElementById("chat").innerHTML="";
    alert("Left chat");
  }
};
document.getElementById("dmsBtn").onclick=function(){shw("dmsModal");};
document.getElementById("chatSettingsBtn").onclick=function(){shw("chatSettingsModal");};
</script>
</body>
</html>
