<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Peer Chat</title>
<style>
body { font-family:sans-serif; background:#0a0a0a; color:#eee; text-align:center; padding:20px; }
#chat { border:1px solid #444; padding:10px; max-width:600px; margin:auto; height:400px; overflow-y:auto; text-align:left; background:#111; }
textarea { width:80%; height:50px; background:#222; color:#fff; border:1px solid #555; padding:5px; }
button { padding:10px; margin:10px; background:#0ff; border:none; cursor:pointer; }
.user { color:#0f0; margin:5px 0; }
.friend { color:#0ff; margin:5px 0; }
</style>
</head>
<body>
<h1>âš¡ Peer-to-Peer Chat</h1>
<div id="chat"></div>
<textarea id="msg" placeholder="Type a message..."></textarea><br>
<button onclick="send()">Send</button>

<script>
let localConnection, dataChannel;
const chat = document.getElementById("chat");

// Random username from list
const usernames = ["Neo", "Pixel", "Glitch", "Cipher", "Echo", "Nova", "Vortex", "Shadow", "Blip", "Spark",
                   "Quantum", "Frost", "Byte", "Laser", "Pulse", "Zen", "Orbit", "Drift", "Flux", "Arc"];
const myName = usernames[Math.floor(Math.random()*usernames.length)];

// Free public WebSocket signaling server
const signaling = new WebSocket("wss://demo-signaling-server.herokuapp.com/"); 

signaling.onmessage = async (msg) => {
  const data = JSON.parse(msg.data);
  if(data.offer && !localConnection) await receiveOffer(data.offer);
  if(data.answer) await receiveAnswer(data.answer);
  if(data.candidate) localConnection?.addIceCandidate(data.candidate);
};

// Initialize WebRTC
async function initConnection() {
  localConnection = new RTCPeerConnection();

  dataChannel = localConnection.createDataChannel("chat");
  dataChannel.onmessage = (e) => addLine(e.data, "friend");

  localConnection.onicecandidate = e => {
    if(e.candidate) signaling.send(JSON.stringify({candidate:e.candidate}));
  };

  const offer = await localConnection.createOffer();
  await localConnection.setLocalDescription(offer);
  signaling.send(JSON.stringify({offer}));
}

async function receiveOffer(offer) {
  localConnection = new RTCPeerConnection();
  localConnection.ondatachannel = (e) => {
    dataChannel = e.channel;
    dataChannel.onmessage = (ev)=> addLine(ev.data,"friend");
  };
  localConnection.onicecandidate = e => {
    if(e.candidate) signaling.send(JSON.stringify({candidate:e.candidate}));
  };
  await localConnection.setRemoteDescription(offer);
  const answer = await localConnection.createAnswer();
  await localConnection.setLocalDescription(answer);
  signaling.send(JSON.stringify({answer}));
}

async function receiveAnswer(answer) {
  await localConnection.setRemoteDescription(answer);
}

function addLine(text, cls){
  const div = document.createElement("div");
  div.className = cls;
  div.textContent = text;
  chat.appendChild(div);
  chat.scrollTop = 99999;
}

function send(){
  const msg = document.getElementById("msg").value;
  if(!msg.trim()) return;
  const message = `${myName}: ${msg}`;
  addLine(message, "user");
  dataChannel?.send(message);
  document.getElementById("msg").value = "";
}

initConnection();
</script>
</body>
</html>
