<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>HyphonChat</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
:root{--bg-dark:#111;--text-dark:#eee;--bg-light:#f5f5f5;--text-light:#111;}
body{font-family:'Inter',sans-serif;margin:0;padding:0;background:var(--bg-dark);color:var(--text-dark);}
#startup,#chatUI{position:fixed;top:0;left:0;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;background:var(--bg-dark);z-index:10;}
#chatUI{display:none;flex-direction:column;padding:20px;box-sizing:border-box;}
#myChatsContainer{margin-bottom:10px;}
#chat{border:1px solid #444;padding:10px;height:400px;overflow-y:auto;border-radius:12px;background:#222;flex:1;display:none;flex-direction:column;}
textarea{width:100%;max-width:80%;height:50px;padding:10px;border-radius:8px;border:1px solid #555;margin-top:10px;resize:none;display:none;}
button{padding:10px 15px;border:none;border-radius:8px;margin-left:5px;cursor:pointer;}
.userBubble{padding:8px 12px;border-radius:15px;margin:5px 0;max-width:70%;word-wrap:break-word;align-self:flex-end;color:#fff;font-weight:500;position:relative;}
.friendBubble{padding:8px 12px;border-radius:15px;margin:5px 0;max-width:70%;word-wrap:break-word;align-self:flex-start;color:#fff;font-weight:500;position:relative;}
.usernameLabel{font-size:12px;color:#aaa;margin-left:5px;margin-bottom:2px;}
.joinMsg{color:#aaa;text-align:center;font-style:italic;margin:5px 0;}
.timestamp{font-size:10px;color:#ccc;margin-left:5px;}
#toggleMode{position:absolute;top:10px;right:10px;padding:5px 10px;border-radius:6px;}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);justify-content:center;align-items:center;z-index:50;}
.modalContent{background:#222;color:#fff;padding:20px;border-radius:12px;text-align:center;min-width:250px;}
.modalContent input{padding:8px;margin:8px;border-radius:6px;border:none;}
.modalContent button{margin-top:5px;padding:8px 12px;}
.editDelete{position:absolute;top:-5px;right:-5px;display:none;gap:4px;}
.editDelete button{padding:2px 5px;font-size:12px;border-radius:4px;}
.typingIndicator{font-style:italic;color:#aaa;font-size:12px;margin:3px 0;}
</style>
</head>
<body>

<!-- Startup -->
<div id="startup">
  <h1>Welcome to HyphonChat!</h1>
  <div>
    <button onclick="makeAccountUI()">Sign Up for Free</button>
    <button onclick="openAccountUI()">Log In</button>
  </div>
</div>

<!-- Chat UI -->
<div id="chatUI">
  <button id="toggleMode" onclick="toggleMode()">Toggle Light/Dark</button>
  <div id="myChatsContainer">
    <h4>My Chats</h4>
    <div id="myChatsList"></div>
  </div>
  <div id="chatContainer">
    <div style="margin-bottom:10px;" id="topButtons">
      <button onclick="openAccountModalClean()">Account</button>
      <button onclick="showNewChat()">New Chat</button>
      <button onclick="leaveChat()">Leave Chat</button>
    </div>
    <div id="chat"></div>
    <div id="typingDiv" class="typingIndicator"></div>
    <textarea id="msg" placeholder="Type a message..."></textarea>
    <button id="sendBtn" onclick="sendMessage()">Send</button>
  </div>
</div>

<!-- Modals -->
<div id="modal" class="modal"><div class="modalContent"><div id="modalText"></div><button onclick="closeModal()">X</button></div></div>

<!-- Account Modal -->
<div id="accountModal" class="modal"><div class="modalContent">
  <div id="accountText"></div>
  <input id="accountInput" placeholder="Enter name"/>
  <input id="accountPassword" type="password" placeholder="Password (optional)"/>
  <div id="accountExtras"></div>
  <button onclick="submitAccount()">Submit</button>
  <button onclick="closeAccountModal()">X</button>
</div></div>

<!-- Chat Modals -->
<div id="newChatModal" class="modal"><div class="modalContent">
  <button onclick="createChatUI()">Create Chat</button>
  <button onclick="joinChatUI()">Join Chat</button>
  <button onclick="closeNewChat()">X</button>
</div></div>
<div id="createChatModal" class="modal"><div class="modalContent">
  <div>Create Chat</div><input id="createChatName" placeholder="Chat name"/><button onclick="submitCreateChat()">Create</button><button onclick="closeCreateChat()">X</button>
</div></div>
<div id="joinChatModal" class="modal"><div class="modalContent">
  <div>Join Chat</div><input id="joinChatCode" placeholder="Chat code"/><button onclick="submitJoinChat()">Join</button><button onclick="closeJoinChat()">X</button>
</div></div>

<!-- Friends/DMs Modals -->
<div id="addFriendModal" class="modal"><div class="modalContent">
  <h3>Add Friend</h3>
  <input id="addFriendInput" placeholder="Friend username"/>
  <button onclick="submitAddFriend()">Send Request</button>
  <button onclick="closeAddFriend()">X</button>
</div></div>

<div id="friendRequestsModal" class="modal"><div class="modalContent">
  <h3>Friend Requests</h3>
  <div id="friendRequestsList"></div>
  <button onclick="closeFriendRequests()">X</button>
</div></div>

<div id="dmsModal" class="modal"><div class="modalContent">
  <h3>DMs</h3>
  <div id="friendsList"></div>
  <button onclick="closeDMs()">X</button>
</div></div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script>
// Firebase
const firebaseConfig={apiKey:"AIzaSyCSh6K8e_CAswGyYuIvgMVKZ3T8b5gGKFU",authDomain:"hyphonchat.firebaseapp.com",databaseURL:"https://hyphonchat-default-rtdb.firebaseio.com",projectId:"hyphonchat",storageBucket:"hyphonchat.firebasestorage.app",messagingSenderId:"172774813412",appId:"1:172774813412:web:8d307b6a170bf270cfc6f1"};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

// Vars
let myName="", myColor="#1abc9c", isDark=true;
let currentChat=null, sending=false;
const chatDiv=document.getElementById("chat");
const typingDiv=document.getElementById("typingDiv");
const maxMessages=40;
const standardColors=["#1abc9c","#3498db","#e74c3c","#f1c40f","#9b59b6"];
const secretColors=["linear-gradient(45deg,#ff6ec4,#7873f5)","linear-gradient(45deg,#00f260,#0575e6)","linear-gradient(45deg,#ff512f,#dd2476)"];
let chatListener=null;
let typingTimeout;
let lastUser=null, lastTime=0;

// --- MODAL HELPERS ---
function showModalText(t){document.getElementById("modalText").innerText=t;document.getElementById("modal").style.display="flex";}
function closeModal(){document.getElementById("modal").style.display="none";}
function showAccountModalClean(){openAccountModalClean();}
function closeAccountModal(){document.getElementById("accountModal").style.display="none";}
function showNewChat(){document.getElementById("newChatModal").style.display="flex";}
function closeNewChat(){document.getElementById("newChatModal").style.display="none";}
function createChatUI(){closeNewChat();document.getElementById("createChatName").value="";document.getElementById("createChatModal").style.display="flex";}
function joinChatUI(){closeNewChat();document.getElementById("joinChatCode").value="";document.getElementById("joinChatModal").style.display="flex";}
function closeCreateChat(){document.getElementById("createChatModal").style.display="none";}
function closeJoinChat(){document.getElementById("joinChatModal").style.display="none";}

// --- MODE ---
function setMode(mode){isDark=mode==="dark";document.body.style.background=isDark?"#111":"#f5f5f5";document.body.style.color=isDark?"#eee":"#111";chatDiv.style.background=isDark?"#222":"#ddd";}
function toggleMode(){setMode(isDark?"light":"dark");}

// --- ACCOUNT ---
function makeAccountUI(){document.getElementById("accountText").innerText="Create Account";document.getElementById("accountModal").style.display="flex";}
function openAccountUI(){document.getElementById("accountText").innerText="Open Account";document.getElementById("accountModal").style.display="flex";}
function submitAccount(){
  const name=document.getElementById("accountInput").value.trim();
  const pass=document.getElementById("accountPassword").value||"";
  if(!name){alert("Enter name");return;}
  const isCreating=document.getElementById("accountText").innerText==="Create Account";
  db.ref("users/"+name).get().then(snap=>{
    if(isCreating){
      if(snap.exists()){alert("Name taken!");return;}
      myName=name; myColor=standardColors[0];
      db.ref("users/"+name).set({color:myColor,password:pass||null,myChats:{},friends:{},requests:{},joinedChats:{},joinTime:Date.now()}); 
      startChatUI(); closeAccountModal(); updateMyChatsList();
    } else{
      if(!snap.exists()){alert("Name not found!");return;}
      const requiredPass=snap.val().password;
      if(requiredPass && requiredPass!==pass){alert("Incorrect password!");return;}
      myName=name; myColor=snap.val().color||standardColors[0]; startChatUI(); closeAccountModal(); updateMyChatsList();
    }
  });
}

// --- CHAT UI ---
function startChatUI(){
  document.getElementById("startup").style.display="none";
  document.getElementById("chatUI").style.display="flex";
  chatDiv.style.display="none";
  document.getElementById("msg").style.display="none";
  document.getElementById("sendBtn").style.display="none";
}

// --- UPDATE MY CHATS ---
function updateMyChatsList(){
  const container = document.getElementById("myChatsList");
  container.innerHTML="";
  db.ref(`users/${myName}/myChats`).get().then(snap=>{
    snap.forEach(c=>{
      const code = c.key;
      const name = c.val();
      const btn = document.createElement("button");
      btn.textContent = name;
      btn.onclick = () => { joinChat(code); };
      container.appendChild(btn);
    });
  });
}

// --- SEND MESSAGE ---
function sendMessage(){
  if(sending||!currentChat)return;
  const txt=document.getElementById("msg").value.trim();
  if(!txt)return;
  sending=true;
  document.getElementById("msg").value="";
  db.ref("messages/"+currentChat).push({user:myName,text:txt,color:myColor,timestamp:Date.now()}).then(()=>{sending=false;});
}

// --- LISTEN / JOIN CHAT ---
function joinChat(code){
  currentChat = code;
  chatDiv.innerHTML="";
  chatDiv.style.display="flex";
  document.getElementById("msg").style.display="block";
  document.getElementById("sendBtn").style.display="inline-block";

  db.ref(`chats/${code}/members/${myName}`).set(true);

  // Only send "joined" message if first time
  db.ref(`users/${myName}/joinedChats/${code}`).get().then(snap=>{
    if(!snap.exists()){
      db.ref(`messages/${code}`).push({
        system:true,
        text:`[${code}] ${myName} Joined`,
        timestamp:Date.now()
      });
      db.ref(`users/${myName}/joinedChats/${code}`).set(true);
    }
  });

  listenMessages();
  listenTyping();
  updateMyChatsList();
}

function leaveChat(){
  if(!currentChat) return;
  if(!confirm("Are you sure you want to leave this chat?")) return;
  db.ref(`chats/${currentChat}/members/${myName}`).remove();
  currentChat=null; chatDiv.innerHTML=""; chatDiv.style.display="none";document.getElementById("msg").style.display="none";document.getElementById("sendBtn").style.display="none";
}

// --- MESSAGES ---
function listenMessages(){
  if(chatListener) db.ref("messages/"+currentChat).off("child_added",chatListener);
  chatListener=db.ref("messages/"+currentChat).on("child_added",snap=>{
    const d=snap.val();
    addMessageBubble(d.user||null,d.text,d.color||null,d.user===myName,d.system,snap.key,d.timestamp);
    pruneMessages();
  });
}

function formatTime(ms){
  const d=new Date(ms);
  let h=d.getHours(); let m=d.getMinutes(); if(m<10)m='0'+m;
  return `${h}:${m}`;
}

function addMessageBubble(user,text,color,isMe,system,key,timestamp){
  const container = document.createElement("div");

  if(system){
    container.className="joinMsg"; 
    container.textContent=`[${formatTime(timestamp)}] ${text}`;
  } else {
    if(user !== lastUser || (timestamp-lastTime)>60000){
      const label = document.createElement("div");
      label.className="usernameLabel";
      label.textContent=user;
      container.appendChild(label);
    }
    lastUser=user; lastTime=timestamp;

    const bubble = document.createElement("div");
    bubble.className = isMe?"userBubble":"friendBubble";
    bubble.style.background=color?.startsWith("linear-gradient")?color:(color||isMe?"#1abc9c":"#444");
    bubble.textContent = text;
    container.appendChild(bubble);

    const timeSpan=document.createElement("span");
    timeSpan.className="timestamp";
    timeSpan.textContent=formatTime(timestamp);
    container.appendChild(timeSpan);

    if(isMe){
      const btnDiv=document.createElement("div");btnDiv.className="editDelete";
      btnDiv.innerHTML='<button onclick="editMsg(\''+key+'\')">Edit</button><button onclick="deleteMsg(\''+key+'\')">Del</button>';
      container.appendChild(btnDiv);
      container.addEventListener("mouseenter",()=>{setTimeout(()=>{btnDiv.style.display="flex";},2000);});
      container.addEventListener("mouseleave",()=>{btnDiv.style.display="none";});
    }
  }

  chatDiv.appendChild(container); chatDiv.scrollTop=chatDiv.scrollHeight;
}

function pruneMessages(){
  db.ref("messages/"+currentChat).get().then(snap=>{
    const msgs=Object.entries(snap.val()||{});
    if(msgs.length>maxMessages){
      const excess=msgs.slice(0,msgs.length-maxMessages);
      excess.forEach(m=>{db.ref("messages/"+currentChat+"/"+m[0]).remove();});
    }
  });
}

// --- TYPING ---
document.getElementById("msg").addEventListener("input",()=>{
  if(!currentChat) return;
  db.ref(`typing/${currentChat}/${myName}`).set(true);
  clearTimeout(typingTimeout);
  typingTimeout=setTimeout(()=>{db.ref(`typing/${currentChat}/${myName}`).remove();},1500);
});
function listenTyping(){
  db.ref(`typing/${currentChat}`).on("value",snap=>{
    const typingUsers=[];
    snap.forEach(s=>{if(s.key!==myName) typingUsers.push(s.key);});
    typingDiv.textContent=typingUsers.length?typingUsers.join(", ")+" is typing...": "";
  });
}

// --- CREATE / JOIN CHAT ---
function submitCreateChat(){
  const name = document.getElementById("createChatName").value.trim(); 
  if(!name) return;
  const code = Math.floor(10000 + Math.random()*89999);

  db.ref(`chats/${code}`).set({name, members:{[myName]:true}});
  db.ref(`users/${myName}/myChats/${code}`).set(name);

  db.ref(`users/${myName}/joinedChats/${code}`).get().then(snap=>{
    if(!snap.exists()){
      db.ref(`messages/${code}`).push({system:true,text:`[${code}] ${myName} Joined`,timestamp:Date.now()});
      db.ref(`users/${myName}/joinedChats/${code}`).set(true);
    }
  });

  joinChat(code);
  closeCreateChat();
}

function submitJoinChat(){
  const code = document.getElementById("joinChatCode").value.trim();
  if(!code) return;
  db.ref(`chats/${code}`).get().then(snap=>{
    if(!snap.exists()){alert("Chat not found");return;}
    db.ref(`users/${myName}/myChats/${code}`).set(snap.val().name);
    joinChat(code); closeJoinChat();
  });
}

// --- ACCOUNT MODAL ---
function openAccountModalClean(){
  const html=`
    <h3>Account Settings</h3>
    <div>Username: ${myName}</div>
    <input id="changeName" placeholder="Change username"/>
    <input id="changePassword" type="password" placeholder="Password (optional)"/>
    <div>Pick Color:</div>
    ${standardColors.map(c=>`<button onclick="setMyColor('${c}')"
      style="background:${c};color:#fff;margin:2px;"> </button>`).join('')}
    ${myName==='Nether'?secretColors.map(c=>`<button onclick="setMyColor('${c}')"
      style="background:${c};color:#fff;margin:2px;"> </button>`).join(''):''}
    <div style="margin-top:10px;">
      <button onclick="openAddFriendModal()">Add Friend</button>
      <button onclick="openFriendRequests()">Friend Requests</button>
      <button onclick="openDMs()">DMs</button>
      <button onclick="saveAccountChanges()">Save</button>
    </div>`;
  document.getElementById("accountText").innerHTML=html;
  document.getElementById("accountModal").style.display="flex";
}
function setMyColor(c){
  if(secretColors.includes(c) && myName!=="Nether") return alert("You cannot use this color!");
  myColor=c;
  db.ref(`users/${myName}/color`).set(c);
}
function saveAccountChanges(){
  const n=document.getElementById("changeName").value.trim();
  const p=document.getElementById("changePassword").value.trim();
  if(n) myName=n;
  if(p) db.ref(`users/${myName}/password`).set(p);
  closeAccountModal();
}

// --- FRIENDS / DMS PLACEHOLDERS ---
function openAddFriendModal(){document.getElementById("addFriendModal").style.display="flex";}
function closeAddFriend(){document.getElementById("addFriendModal").style.display="none";}
function submitAddFriend(){alert("Friend request sent (placeholder)");}
function openFriendRequests(){document.getElementById("friendRequestsModal").style.display="flex";}
function closeFriendRequests(){document.getElementById("friendRequestsModal").style.display="none";}
function openDMs(){document.getElementById("dmsModal").style.display="flex";}
function closeDMs(){document.getElementById("dmsModal").style.display="none";}
</script>
</body>
</html>
