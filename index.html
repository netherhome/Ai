<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>HyphonChat</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
:root{--bg-dark:#111;--text-dark:#eee;--bg-light:#f5f5f5;--text-light:#111;}
body{font-family:'Inter',sans-serif;margin:0;padding:0;background:var(--bg-dark);color:var(--text-dark);overflow:hidden;}
#startup,#chatUI{position:fixed;top:0;left:0;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;background:var(--bg-dark);z-index:10;}
#chatUI{display:none;flex-direction:column;padding:20px;box-sizing:border-box;}
#chatContainer{display:flex;flex-direction:column;width:100%;max-width:900px;flex:1;}
#chat{border:1px solid #444;padding:10px;height:400px;overflow-y:auto;border-radius:12px;background:#222;flex:1;display:flex;flex-direction:column;display:none;}
textarea{width:100%;max-width:80%;height:50px;padding:10px;border-radius:8px;border:1px solid #555;margin-top:10px;resize:none;display:none;}
button{padding:10px 15px;border:none;border-radius:8px;margin-left:5px;cursor:pointer;}
.userBubble{padding:8px 12px;border-radius:15px;margin:5px 0;max-width:70%;word-wrap:break-word;align-self:flex-end;color:#fff;font-weight:500;}
.friendBubble{padding:8px 12px;border-radius:15px;margin:5px 0;max-width:70%;word-wrap:break-word;align-self:flex-start;color:#fff;font-weight:500;}
#toggleMode{position:absolute;top:10px;right:10px;padding:5px 10px;border-radius:6px;}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);justify-content:center;align-items:center;z-index:50;}
.modalContent{background:#222;color:#fff;padding:20px;border-radius:12px;text-align:center;min-width:250px;}
.modalContent input{padding:8px;margin:8px;border-radius:6px;border:none;}
.modalContent button{margin-top:5px;padding:8px 12px;}
</style>
</head>
<body>

<div id="startup">
  <h1>Welcome to HyphonChat!</h1>
  <div>
    <button onclick="makeAccountUI()">Make Account</button>
    <button onclick="openAccountUI()">Open Account</button>
  </div>
</div>

<div id="chatUI">
  <button id="toggleMode" onclick="toggleMode()">Toggle Light/Dark</button>
  <div id="chatContainer">
    <div style="margin-bottom:10px;" id="topButtons">
      <button onclick="showAccountPanel()">Account</button>
      <button onclick="showCreateChat()">Create Chat</button>
      <button onclick="joinChatPrompt()">Join Chat</button>
      <button onclick="leaveChat()">Leave Chat</button>
      <button onclick="showRecentChats()">Recent Chats</button>
      <button onclick="showAddFriend()">Add Friend</button>
      <button onclick="showFriendRequests()">Friend Requests</button>
      <button onclick="showDMs()">DMs</button>
    </div>
    <div id="chat"></div>
    <textarea id="msg" placeholder="Type a message..."></textarea>
    <button id="sendBtn" onclick="sendMessage()">Send</button>
  </div>
</div>

<!-- Modals -->
<div id="modal" class="modal"><div class="modalContent"><div id="modalText"></div><button onclick="closeModal()">X</button></div></div>
<div id="accountModal" class="modal"><div class="modalContent"><div id="accountText"></div><input id="accountInput" placeholder="Enter name"/><input id="accountPassword" type="password" placeholder="Password (optional)"/><button onclick="submitAccount()">Submit</button><button onclick="closeAccountModal()">X</button></div></div>
<div id="createChatModal" class="modal"><div class="modalContent"><div>Create Chat</div><input id="createChatName" placeholder="Chat name"/><button onclick="submitCreateChat()">Create</button><button onclick="closeCreateChat()">X</button></div></div>
<div id="friendModal" class="modal"><div class="modalContent"><div>Add Friend</div><input id="friendInput" placeholder="Friend name"/><button onclick="submitAddFriend()">Send Request</button><button onclick="closeFriendModal()">X</button></div></div>
<div id="requestsModal" class="modal"><div class="modalContent"><div>Friend Requests</div><div id="requestsList"></div><button onclick="closeRequestsModal()">X</button></div></div>
<div id="dmModal" class="modal"><div class="modalContent"><div>DMs</div><div id="dmList"></div><button onclick="closeDMModal()">X</button></div></div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script>
// Firebase
const firebaseConfig={apiKey:"AIzaSyCSh6K8e_CAswGyYuIvgMVKZ3T8b5gGKFU",authDomain:"hyphonchat.firebaseapp.com",databaseURL:"https://hyphonchat-default-rtdb.firebaseio.com",projectId:"hyphonchat",storageBucket:"hyphonchat.firebasestorage.app",messagingSenderId:"172774813412",appId:"1:172774813412:web:8d307b6a170bf270cfc6f1"};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

// Vars
let myName="", myColor="#1abc9c", isDark=true;
let currentChat=null, sending=false;
const chatDiv=document.getElementById("chat");
const maxMessages=40;

// --- Modal Helpers ---
function showModalText(t){document.getElementById("modalText").innerText=t;document.getElementById("modal").style.display="flex";}
function closeModal(){document.getElementById("modal").style.display="none";}
function showAccountModal(action){document.getElementById("accountText").innerText=action==="make"?"Create Account":"Open Account";document.getElementById("accountModal").style.display="flex";}
function closeAccountModal(){document.getElementById("accountModal").style.display="none";}
function showCreateChat(){document.getElementById("createChatName").value="";document.getElementById("createChatModal").style.display="flex";}
function closeCreateChat(){document.getElementById("createChatModal").style.display="none";}
function showFriendModal(){document.getElementById("friendInput").value="";document.getElementById("friendModal").style.display="flex";}
function closeFriendModal(){document.getElementById("friendModal").style.display="none";}
function showRequestsModal(){document.getElementById("requestsList").innerHTML="";loadFriendRequests();document.getElementById("requestsModal").style.display="flex";}
function closeRequestsModal(){document.getElementById("requestsModal").style.display="none";}
function showDMModal(){document.getElementById("dmList").innerHTML="";loadDMs();document.getElementById("dmModal").style.display="flex";}
function closeDMModal(){document.getElementById("dmModal").style.display="none";}

// --- Mode ---
function setMode(mode){isDark=mode==="dark";document.body.style.background=isDark?"#111":"#f5f5f5";document.body.style.color=isDark?"#eee":"#111";chatDiv.style.background=isDark?"#222":"#ddd";}
function toggleMode(){setMode(isDark?"light":"dark");}

// --- Account ---
const standardColors=["#1abc9c","#3498db","#e74c3c","#f1c40f","#9b59b6"];
const secretColors=["linear-gradient(45deg,#ff6ec4,#7873f5)","linear-gradient(45deg,#00f260,#0575e6)","linear-gradient(45deg,#ff512f,#dd2476)"];
function makeAccountUI(){showAccountModal("make");}
function openAccountUI(){showAccountModal("open");}
function submitAccount(){
  const name=document.getElementById("accountInput").value.trim();
  const pass=document.getElementById("accountPassword").value || "";
  if(!name){alert("Enter name");return;}
  const isCreating=document.getElementById("accountText").innerText==="Create Account";
  db.ref("users/"+name).get().then(snap=>{
    if(isCreating){
      if(snap.exists()){alert("Name taken!");return;}
      myName=name; myColor="#1abc9c";
      db.ref("users/"+name).set({color:myColor,password:pass});
      startChatUI(); closeAccountModal();
    } else{
      if(!snap.exists()){alert("Name not found!");return;}
      if(snap.val().password && snap.val().password!==pass){alert("Incorrect password!");return;}
      myName=name; myColor=snap.val().color||"#1abc9c";
      startChatUI(); closeAccountModal();
    }
  });
}

// --- Start Chat UI ---
function startChatUI(){document.getElementById("startup").style.display="none";document.getElementById("chatUI").style.display="flex"; chatDiv.style.display="none";document.getElementById("msg").style.display="none";document.getElementById("sendBtn").style.display="none";setTopButtonColors();}

// --- Top button colors ---
function setTopButtonColors(){
  const topButtons = document.querySelectorAll("#topButtons > button");
  const btnColors = ["#3498db","#e74c3c","#f1c40f","#9b59b6","#1abc9c","#e67e22","#16a085","#9b59b6"];
  topButtons.forEach((btn,i)=>{btn.style.background = btnColors[i%btnColors.length]; btn.style.color="#fff";});
}

// --- Account Panel ---
function showAccountPanel(){
  const modalContent=document.createElement("div");
  modalContent.className="modalContent";
  modalContent.innerHTML=`
    <div>Account Settings</div>
    <div>Username: <input id="newUsername" value="${myName}"/></div>
    <div>Password (optional): <input type="password" id="newPass" placeholder="Password"/></div>
    <div>Pick Color:</div>
  `;
  standardColors.forEach(c=>{
    const btn=document.createElement("button"); btn.style.background=c; btn.style.margin="5px";
    btn.onclick=()=>{myColor=c; db.ref("users/"+myName+"/color").set(myColor); showModalText("Color changed!");};
    modalContent.appendChild(btn);
  });
  if(myName==="Nether"){
    const secretBtn=document.createElement("button"); secretBtn.textContent="Add Colour"; secretBtn.style.margin="5px"; 
    secretBtn.onclick=()=>addSecretColorToUser(); 
    modalContent.appendChild(secretBtn);
  }
  const saveBtn=document.createElement("button"); saveBtn.textContent="Save"; saveBtn.style.margin="5px"; 
  saveBtn.onclick=()=>{
    const newName=document.getElementById("newUsername").value.trim();
    if(newName && newName!==myName){
      db.ref("users/"+myName).get().then(snap=>{
        if(snap.exists()){
          db.ref("users/"+newName).set(snap.val()); 
          db.ref("users/"+myName).remove(); 
          myName=newName; 
          showModalText("Username updated!");
        }
      });
    } 
    closeModal();
  }; 
  modalContent.appendChild(saveBtn);
  const close=document.createElement("button"); close.textContent="X"; close.style.margin="5px"; close.onclick=()=>closeModal(); 
  modalContent.appendChild(close);
  const modal=document.getElementById("modal"); modal.innerHTML=""; modal.appendChild(modalContent); modal.style.display="flex";
}
function addSecretColorToUser(){
  const user=prompt("Enter username to assign secret color:"); if(!user)return;
  const choice=prompt("Choose secret color 1-3:"); const idx=parseInt(choice)-1;
  if(idx>=0 && idx<secretColors.length){ db.ref("users/"+user+"/color").set(secretColors[idx]); showModalText(`Secret color assigned to ${user}`);} else showModalText("Invalid choice");
}

// --- Chat system ---
function submitCreateChat(){const chatName=document.getElementById("createChatName").value.trim()||"New Chat";const code=Math.floor(10000+Math.random()*90000).toString();const members={};members[myName]=true;db.ref("chats/"+code).set({name:chatName,members});closeCreateChat();showModalText("Chat created! Code: "+code);joinChat(code);}
function joinChatPrompt(){const code=prompt("Enter 5-digit chat code:");if(code) joinChat(code);}
function joinChat(code){currentChat=code;chatDiv.innerHTML="";chatDiv.style.display="flex";document.getElementById("msg").style.display="block";document.getElementById("sendBtn").style.display="inline-block";db.ref("chats/"+code+"/members/"+myName).set(true);listenMessages();}
function leaveChat(){if(!currentChat)return;db.ref("chats/"+currentChat+"/members/"+myName).remove();db.ref("chats/"+currentChat+"/members").get().then(snap=>{if(!snap.exists()) db.ref("chats/"+currentChat).remove();});currentChat=null;chatDiv.style.display="none";document.getElementById("msg").style.display="none";document.getElementById("sendBtn").style.display="none";chatDiv.innerHTML="";}
function listenMessages(){if(!currentChat)return;db.ref("messages/"+currentChat).on("child_added",snap=>{const d=snap.val();addMessageBubble(d.user,d.text,d.color,d.user===myName);pruneMessages();});}
function addMessageBubble(user,text,color,isMe){
  const div=document.createElement("div");
  div.className=isMe?"userBubble":"friendBubble";
  div.textContent=user+": "+text;
  if(color && color.startsWith("linear-gradient")){
    div.style.background=color;
  } else {
    div.style.background=color||(isMe?"#1abc9c":"#444");
  }
  chatDiv.appendChild(div);
  chatDiv.scrollTop=99999;
}
function sendMessage(){if(sending||!currentChat)return;sending=true;const txt=document.getElementById("msg").value.trim();if(!txt){sending=false;return;}document.getElementById("msg").value="";db.ref("messages/"+currentChat).push({user:myName,text:txt,color:myColor}).then(()=>{sending=false;});}
function pruneMessages(){db.ref("messages/"+currentChat).once("value").then(snap=>{if(snap.numChildren()>maxMessages){const keys=Object.keys(snap.val()).sort();const del=keys.slice(0,snap.numChildren()-maxMessages);del.forEach(k=>db.ref("messages/"+currentChat+"/"+k).remove());}});}

// --- Friend System ---
function showAddFriend(){showFriendModal();}
function submitAddFriend(){const f=document.getElementById("friendInput").value.trim();if(!f||f===myName){alert("Invalid friend");return;}db.ref("friendRequests/"+f+"/"+myName).set(true);closeFriendModal();showModalText("Request sent!");}
function loadFriendRequests(){db.ref("friendRequests/"+myName).once("value").then(snap=>{document.getElementById("requestsList").innerHTML="";snap.forEach(s=>{const div=document.createElement("div");div.textContent=s.key;const accept=document.createElement("button");accept.textContent="Accept";accept.onclick=()=>{db.ref("friends/"+myName+"/"+s.key).set(true);db.ref("friends/"+s.key+"/"+myName).set(true);db.ref("friendRequests/"+myName+"/"+s.key).remove();closeRequestsModal();showModalText("Friend added!");};div.appendChild(accept);document.getElementById("requestsList").appendChild(div);});});}
function showFriendRequests(){showRequestsModal();}

// --- DM System ---
function showDMs(){showDMModal();}
function loadDMs(){db.ref("friends/"+myName).once("value").then(snap=>{const dmList=document.getElementById("dmList");dmList.innerHTML="";snap.forEach(f=>{const btn=document.createElement("button");btn.textContent=f.key;btn.onclick=()=>openDM(f.key);dmList.appendChild(btn);});});}
function openDM(friend){const code=[myName,friend].sort().join("_");joinChat(code);}
</script>
</body>
</html>
