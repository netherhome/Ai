<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>HyphonChat</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
:root{
  --bg-dark:#111; --text-dark:#eee;
  --bg-light:#f5f5f5; --text-light:#111;
}
body{font-family:'Inter',sans-serif;margin:0;padding:0;background:var(--bg-dark);color:var(--text-dark);overflow:hidden;}
#startup,#chatUI{position:fixed;top:0;left:0;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;background:var(--bg-dark);z-index:10;}
#chatUI{display:none;flex-direction:column;padding:20px;box-sizing:border-box;}
#chatContainer{display:flex;flex-direction:column;width:100%;max-width:900px;flex:1;}
#chatList{display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap;}
.chatItem{padding:5px 10px;background:#333;border-radius:8px;cursor:pointer;user-select:none;}
#chat{border:1px solid #444;padding:10px;height:400px;overflow-y:auto;border-radius:12px;background:#222;flex:1;display:flex;flex-direction:column;}
textarea{width:100%;max-width:80%;height:50px;padding:10px;border-radius:8px;border:1px solid #555;margin-top:10px;resize:none;}
button{padding:10px 15px;border:none;border-radius:8px;margin-left:5px;cursor:pointer;}
.userBubble{padding:8px 12px;border-radius:15px;margin:5px 0;max-width:70%;word-wrap:break-word;align-self:flex-end;color:#fff;font-weight:500;}
.friendBubble{padding:8px 12px;border-radius:15px;margin:5px 0;max-width:70%;word-wrap:break-word;align-self:flex-start;color:#fff;font-weight:500;}
#toggleMode{position:absolute;top:10px;right:10px;padding:5px 10px;border-radius:6px;}
#modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);justify-content:center;align-items:center;z-index:50;}
#modalContent{background:#222;color:#fff;padding:20px;border-radius:12px;text-align:center;min-width:200px;}
#modalClose{margin-top:10px;padding:5px 10px;border:none;border-radius:6px;cursor:pointer;}
</style>
</head>
<body>

<div id="startup">
  <h1>Welcome to HyphonChat!</h1>
  <div>
    <button onclick="makeAccountUI()">Make Account</button>
    <button onclick="openAccountUI()">Open Account</button>
  </div>
</div>

<div id="chatUI">
  <button id="toggleMode" onclick="toggleMode()">Toggle Light/Dark</button>
  <div id="chatContainer">
    <div style="margin-bottom:10px;">
      <button onclick="showRecentChats()">Recent Chats</button>
      <button onclick="createChat()">Create Chat</button>
      <button onclick="joinChatPrompt()">Join Chat</button>
    </div>
    <div id="chatList" style="display:none;"></div>
    <div id="chat" style="display:none;"></div>
    <textarea id="msg" placeholder="Type a message..." style="display:none;"></textarea>
    <button id="sendBtn" onclick="sendMessage()" style="display:none;">Send</button>
  </div>
</div>

<div id="modal">
  <div id="modalContent">
    <div id="modalText"></div>
    <button id="modalClose" onclick="closeModal()">X</button>
  </div>
</div>

<div id="accountModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);justify-content:center;align-items:center;z-index:60;">
  <div style="background:#222;color:#fff;padding:20px;border-radius:12px;text-align:center;min-width:200px;">
    <div id="accountText"></div>
    <input id="accountInput" type="text" placeholder="Enter name" style="padding:10px;margin:10px;border-radius:6px;border:none;">
    <button onclick="submitAccount()">Submit</button>
    <button onclick="closeAccountModal()">X</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script>
// Firebase
const firebaseConfig = {
  apiKey:"AIzaSyCSh6K8e_CAswGyYuIvgMVKZ3T8b5gGKFU",
  authDomain:"hyphonchat.firebaseapp.com",
  databaseURL:"https://hyphonchat-default-rtdb.firebaseio.com",
  projectId:"hyphonchat",
  storageBucket:"hyphonchat.firebasestorage.app",
  messagingSenderId:"172774813412",
  appId:"1:172774813412:web:8d307b6a170bf270cfc6f1"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

// Variables
let myName="", myColor="#1abc9c", isDark=true;
let currentChat=null, sending=false;
const maxMessages=40;
const chatDiv=document.getElementById("chat");
const chatListDiv=document.getElementById("chatList");
let accountAction="make";

// ===== Modal =====
function showModal(text){document.getElementById("modalText").innerText=text;document.getElementById("modal").style.display="flex";}
function closeModal(){document.getElementById("modal").style.display="none";}
function showAccountModal(action){accountAction=action;document.getElementById("accountInput").value="";document.getElementById("accountText").innerText=action==="make"?"Create Account":"Open Account";document.getElementById("accountModal").style.display="flex";}
function closeAccountModal(){document.getElementById("accountModal").style.display="none";}

// ===== Mode =====
function setMode(mode){isDark=mode==="dark";document.body.style.background=isDark?"#111":"#f5f5f5";document.body.style.color=isDark?"#eee":"#111";document.getElementById("chat").style.background=isDark?"#222":"#ddd";}
function toggleMode(){setMode(isDark?"light":"dark");}

// ===== Startup =====
function makeAccountUI(){showAccountModal("make");}
function openAccountUI(){showAccountModal("open");}
function submitAccount(){
  const name=document.getElementById("accountInput").value.trim();
  if(!name){alert("Enter a name!");return;}
  if(accountAction==="make"){
    db.ref("users/"+name).get().then(snap=>{
      if(snap.exists()){alert("Name taken!");return;}
      myName=name; myColor="#1abc9c"; db.ref("users/"+name).set({color:myColor});
      startChatUI();
      closeAccountModal();
    });
  }else{
    db.ref("users/"+name).get().then(snap=>{
      if(!snap.exists()){alert("Name not found!");return;}
      myName=name; myColor=snap.val().color||"#1abc9c";
      startChatUI();
      closeAccountModal();
    });
  }
}

// ===== Start Chat UI =====
function startChatUI(){
  document.getElementById("startup").style.display="none";
  document.getElementById("chatUI").style.display="flex";
  chatDiv.style.display="none"; document.getElementById("msg").style.display="none"; document.getElementById("sendBtn").style.display="none";
}

// ===== Recent chats popup =====
function showRecentChats(){
  chatListDiv.innerHTML=""; chatListDiv.style.display="flex";
  db.ref("chats").once("value").then(snap=>{
    let found=false;
    snap.forEach(c=>{
      const chatKey=c.key; const members=c.val().members||{};
      if(members[myName]){found=true;
        const div=document.createElement("div"); div.className="chatItem"; div.textContent=c.val().name||chatKey;
        div.onclick=()=>joinChat(chatKey); chatListDiv.appendChild(div);
      }
    });
    if(!found){showModal("No recent chats found!"); chatListDiv.style.display="none";}
  });
}

// ===== Chat create/join =====
function createChat(){
  const code=Math.floor(10000+Math.random()*90000).toString();
  const name=prompt("Enter chat name (optional)","New Chat")||"New Chat";
  const members={}; members[myName]=true;
  db.ref("chats/"+code).set({name,members});
  showModal("Chat created! Code: "+code);
  joinChat(code);
}

function joinChatPrompt(){
  const code=prompt("Enter 5-digit chat code:");
  if(code) joinChat(code);
}

function joinChat(chatCode){
  currentChat=chatCode; chatDiv.innerHTML="";
  chatDiv.style.display="flex"; document.getElementById("msg").style.display="block"; document.getElementById("sendBtn").style.display="inline-block";
  db.ref("chats/"+chatCode+"/members/"+myName).set(true);
  listenMessages();
}

// ===== Messages =====
function listenMessages(){
  if(!currentChat) return;
  db.ref("messages/"+currentChat).on("child_added",snap=>{
    const data=snap.val();
    addMessageBubble(data.user,data.text,data.color,data.user===myName);
    pruneMessages();
  });
}

function addMessageBubble(user,text,color,isMe){
  const div=document.createElement("div");
  div.className=isMe?"userBubble":"friendBubble";
  div.textContent=user+": "+text;
  div.style.background=isMe? color : color||"#444";
  chatDiv.appendChild(div); chatDiv.scrollTop=99999;
}

function sendMessage(){
  if(sending) return; sending=true;
  const txt=document.getElementById("msg").value.trim();
  if(!txt || !currentChat){sending=false; return;}
  document.getElementById("msg").value="";
  db.ref("messages/"+currentChat).push({user:myName,text:txt,color:myColor}).then(()=>{sending=false;});
}

function pruneMessages(){
  db.ref("messages/"+currentChat).once("value").then(snap=>{
    if(snap.numChildren()>maxMessages){
      const keys=Object.keys(snap.val()).sort();
      const del=keys.slice(0,snap.numChildren()-maxMessages);
      del.forEach(k=>db.ref("messages/"+currentChat+"/"+k).remove());
    }
  });
}

setMode("dark");
</script>
</body>
</html>
