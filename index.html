<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>HyphonChat</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
:root{--bg-dark:#111;--text-dark:#eee;}
body{font-family:'Inter',sans-serif;margin:0;padding:0;background:var(--bg-dark);color:var(--text-dark);}
#startupScreen{position:fixed;top:0;left:0;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(135deg,#3498db,#9b59b6);color:#fff;z-index:20;}
#chatUI{display:none;flex-direction:column;padding:20px;box-sizing:border-box;height:100vh;}
#chatContainer{display:flex;flex-direction:column;width:100%;max-width:900px;flex:1;margin:0 auto;}
#chat{border:1px solid #444;padding:10px;height:400px;overflow-y:auto;border-radius:12px;background:#222;flex:1;display:flex;flex-direction:column;scroll-behavior:smooth;}
textarea{width:100%;height:50px;padding:10px;border-radius:8px;border:1px solid #555;margin-top:10px;font-weight:bold;background:linear-gradient(135deg,#3498db,#2980b9);color:#fff;resize:none;}
button{padding:10px 15px;border:none;border-radius:8px;margin-left:5px;cursor:pointer;background:linear-gradient(135deg,#f1c40f,#e67e22);color:#fff;font-weight:600;}
.userBubble,.friendBubble{padding:8px 12px;border-radius:15px;margin:5px 0;max-width:60%;word-wrap:break-word;position:relative;}
.userBubble{align-self:flex-end;background:#1abc9c;color:#fff;}
.friendBubble{align-self:flex-start;background:#555;color:#fff;}
.joinMsg{color:#aaa;text-align:center;font-style:italic;margin:5px 0;}
.timestamp{font-size:10px;color:#ccc;margin-left:5px;}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);justify-content:center;align-items:center;z-index:50;}
.modalContent{background:linear-gradient(135deg,#3498db,#2980b9);color:#fff;padding:20px;border-radius:12px;text-align:center;min-width:250px;}
.modalContent input{padding:8px;margin:8px;border-radius:6px;border:none;}
.modalContent button{margin-top:5px;padding:8px 12px;}
.headerBtns{display:flex;justify-content:center;margin-bottom:10px;}
.headerBtns button{margin:0 5px;}
.userNameDiv{font-weight:bold;margin-bottom:2px;}
.pfp{width:32px;height:32px;border-radius:50%;margin-right:5px;vertical-align:middle;}
</style>
</head>
<body>

<!-- Startup Screen -->
<div id="startupScreen">
  <h1>Welcome to Hyphon Chat</h1>
  <div>
    <button id="signupBtn">Sign Up for Free</button>
  </div>
</div>

<div id="chatUI">
  <div class="headerBtns">
    <button id="accBtn">Account</button>
    <button id="chatsBtn">My Chats</button>
    <button id="newChatBtn">New Chat</button>
    <button id="leaveBtn">Leave Chat</button>
    <button id="dmsBtn">DMs</button>
  </div>
  <div id="chatContainer">
    <div id="chat"></div>
    <textarea id="msg" placeholder="Type your message..."></textarea>
    <button id="sendBtn">Send</button>
    <div id="typingDiv" style="font-size:12px;color:#aaa;margin-top:4px;"></div>
  </div>
</div>

<!-- Modals -->
<div id="accModal" class="modal"><div class="modalContent" id="accBox"></div></div>
<div id="chatsModal" class="modal"><div class="modalContent"><h3>My Chats</h3><div id="chatList"></div><button onclick="cls('chatsModal')">X</button></div></div>
<div id="newModal" class="modal"><div class="modalContent"><button onclick="mkChat()">Create Chat</button><button onclick="jnChat()">Join Chat</button><button onclick="cls('newModal')">X</button></div></div>
<div id="mkModal" class="modal"><div class="modalContent"><input id="mkName" placeholder="Chat name"><button onclick="subMk()">Go</button><button onclick="cls('mkModal')">X</button></div></div>
<div id="jnModal" class="modal"><div class="modalContent"><input id="jnCode" placeholder="Chat code"><button onclick="subJn()">Go</button><button onclick="cls('jnModal')">X</button></div></div>
<div id="friendReqModal" class="modal"><div class="modalContent"><h3>Friend Requests</h3><div id="friendRequests"></div><button onclick="cls('friendReqModal')">X</button></div></div>
<div id="dmsModal" class="modal"><div class="modalContent"><h3>DMs</h3><div id="dmsList"></div><button onclick="cls('dmsModal')">X</button></div></div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script>
// --- Firebase setup ---
const fb={apiKey:"AIzaSyCSh6K8e_CAswGyYuIvgMVKZ3T8b5gGKFU",authDomain:"hyphonchat.firebaseapp.com",databaseURL:"https://hyphonchat-default-rtdb.firebaseio.com",projectId:"hyphonchat",storageBucket:"hyphonchat.firebasestorage.app",messagingSenderId:"172774813412",appId:"1:172774813412:web:8d307b6a170bf270cfc6f1"};
firebase.initializeApp(fb);
const db=firebase.database();

// --- Variables ---
let me="", myColor="#1abc9c", myPfp="https://th.bing.com/th/id/OIP.Xx93W3aTtFensmWsSFuDYAHaHa?w=202&h=202&c=7&r=0&o=7&dpr=1.3&pid=1.7&rm=3";
let currentChat=null, sending=false, listener=null, typingTimeout;
const chatDiv=document.getElementById("chat");

// --- Startup ---
document.addEventListener("DOMContentLoaded",()=>{
  document.getElementById("signupBtn").addEventListener("click",()=>{
    accUI('Create');
    document.getElementById("startupScreen").style.display="none";
  });
});

// --- Account UI ---
function accUI(type){
  let box=document.getElementById("accBox");
  let modal=document.getElementById("accModal");

  if(type==="Create"){ // Sign Up
    box.innerHTML=`
      <h3>Create Account</h3>
      <input id="newName" placeholder="Username"><br>
      <input id="newPass" type="password" placeholder="Password"><br>
      <button onclick="doCreate()">Create</button>
      <button onclick="cls('accModal')">X</button>`;
    modal.style.display="flex";
    return;
  }

  if(type==="Login"){ // Login
    box.innerHTML=`
      <h3>Log In</h3>
      <input id="logName" placeholder="Username"><br>
      <input id="logPass" type="password" placeholder="Password"><br>
      <button onclick="doLogin()">Log In</button>
      <button onclick="cls('accModal')">X</button>`;
    modal.style.display="flex";
    return;
  }

  if(type==="Settings" && me){ // Account Settings
    box.innerHTML=`
      <h3>Account Settings</h3>
      <div><img src="${myPfp}" width=64 height=64 style="border-radius:50%"></div>
      <p>Username: ${me}</p>
      <label>Change Username:</label><input id="chgName"><button onclick="chgName()">Save</button><br>
      <label>Profile Pic URL:</label><input id="chgPfp"><button onclick="chgPfp()">Save</button><br>
      <label>Msg Color:</label><input id="chgCol" type="color" value="${myColor}"><button onclick="chgColBtn()">Save</button><br>
      <button onclick="opn('friendReqModal')">Friend Requests</button>
      <button onclick="opn('dmsModal')">DMs</button>
      <button onclick="logout()">Logout</button>
      <button onclick="cls('accModal')">X</button>`;
    modal.style.display="flex";
    return;
  }
}

// --- Account Functions ---
function doCreate(){
  const n=document.getElementById("newName").value.trim();
  const p=document.getElementById("newPass").value;
  if(!n) return alert("Enter username");
  db.ref("users/"+n).get().then(s=>{
    if(s.exists()) return alert("Name taken!");
    me=n;
    db.ref("users/"+n).set({password:p||null,color:myColor,pfp:myPfp,myChats:{},friends:{},requests:{}});
    startChatUI();
    cls('accModal');
  });
}

function doLogin(){
  const n=document.getElementById("logName").value.trim();
  const p=document.getElementById("logPass").value;
  db.ref("users/"+n).get().then(s=>{
    if(!s.exists()) return alert("Not found!");
    if(s.val().password && s.val().password!==p) return alert("Wrong password!");
    me=n; myColor=s.val().color||myColor; myPfp=s.val().pfp||myPfp;
    startChatUI();
    cls('accModal');
  });
}

function chgName(){
  const n=document.getElementById("chgName").value.trim();
  if(!n) return;
  db.ref("users/"+me).once("value").then(s=>{
    const d=s.val();
    db.ref("users/"+n).set(d);
    db.ref("users/"+me).remove();
    me=n;
    alert("Username changed!");
  });
}

function chgPfp(){
  const u=document.getElementById("chgPfp").value.trim();
  if(!u) return;
  myPfp=u;
  db.ref("users/"+me+"/pfp").set(u);
}

function chgColBtn(){
  const c=document.getElementById("chgCol").value;
  myColor=c;
  db.ref("users/"+me+"/color").set(c);
}

function logout(){
  me=""; currentChat=null; document.getElementById("chatUI").style.display="none";
  document.getElementById("startupScreen").style.display="flex";
  cls('accModal');
}

// --- Start Chat UI ---
function startChatUI(){
  document.getElementById("chatUI").style.display="flex";
  chatDiv.innerHTML="";
  document.getElementById("msg").value="";
}

// --- Buttons ---
document.getElementById("accBtn").onclick=()=>accUI('Settings');
document.getElementById("chatsBtn").onclick=openChats;
document.getElementById("newChatBtn").onclick=newChat;
document.getElementById("leaveBtn").onclick=leaveChat;
document.getElementById("dmsBtn").onclick=openDMs;
document.getElementById("sendBtn").onclick=sendMsg;

// --- Create / Join / Leave Chat ---
function newChat(){cls('newModal');document.getElementById("newModal").style.display="flex";}
function mkChat(){cls('newModal');document.getElementById("mkModal").style.display="flex";}
function jnChat(){cls('newModal');document.getElementById("jnModal").style.display="flex";}

function subMk(){
  const n=document.getElementById("mkName").value.trim();
  if(!n) return alert("Enter chat name");
  const code=Math.floor(10000+Math.random()*89999);
  db.ref("chats/"+code).set({name:n,members:{[me]:true}});
  db.ref("users/"+me+"/myChats/"+code).set(n);
  currentChat=code;
  chatDiv.innerHTML="";
  listenMsgs();
  listenTyping();
  db.ref("messages/"+code).push({txt:`[${code}] ${me} joined`,system:true,timestamp:Date.now()});
  cls('mkModal');
}

function subJn(){
  const c=document.getElementById("jnCode").value.trim();
  if(!c) return alert("Enter chat code");
  db.ref("chats/"+c).get().then(s=>{
    if(!s.exists()) return alert("Chat not found");
    db.ref("users/"+me+"/myChats/"+c).set(s.val().name);
    currentChat=c;
    chatDiv.innerHTML="";
    listenMsgs();
    listenTyping();
    db.ref("messages/"+c).push({txt:`[${c}] ${me} joined`,system:true,timestamp:Date.now()});
    cls('jnModal');
  });
}

function leaveChat(){
  if(!currentChat) return;
  if(confirm("Leave chat?")){
    db.ref("chats/"+currentChat+"/members/"+me).remove();
    currentChat=null;
    chatDiv.innerHTML="";
  }
}

// --- Send / Listen Messages ---
function sendMsg(){
  if(!currentChat) return;
  const txt=document.getElementById("msg").value.trim();
  if(!txt) return;
  document.getElementById("msg").value="";
  db.ref("messages/"+currentChat).push({u:me,txt:txt,c:myColor,pic:myPfp,timestamp:Date.now()});
}

function listenMsgs(){
  if(listener) db.ref("messages/"+currentChat).off("child_added",listener);
  listener=db.ref("messages/"+currentChat).on("child_added",snap=>{
    const d=snap.val();
    const row=document.createElement("div");
    if(d.system){
      const j=document.createElement("div"); j.className="joinMsg"; j.textContent=d.txt; row.appendChild(j);
    } else {
      const img=document.createElement("img"); img.className="pfp"; img.src=d.pic||myPfp;
      const msgdiv=document.createElement("div"); msgdiv.className=(d.u==me?"userBubble":"friendBubble");
      const txtDiv=document.createElement("div"); txtDiv.textContent=d.txt; txtDiv.style.fontWeight="bold"; msgdiv.appendChild(txtDiv);
      const tdiv=document.createElement("div"); tdiv.className="timestamp"; tdiv.textContent=new Date(d.timestamp).toLocaleTimeString(); msgdiv.appendChild(tdiv);
      row.appendChild(img); row.appendChild(msgdiv);
    }
    chatDiv.appendChild(row);
    chatDiv.scrollTop=chatDiv.scrollHeight;
  });
}

// --- Typing indicator ---
document.getElementById("msg").addEventListener("input",()=>{
  if(!currentChat) return;
  db.ref("typing/"+currentChat+"/"+me).set(true);
  clearTimeout(typingTimeout);
  typingTimeout=setTimeout(()=>{db.ref("typing/"+currentChat+"/"+me).remove();},1500);
});

function listenTyping(){
  if(!currentChat) return;
  db.ref("typing/"+currentChat).on("value",snap=>{
    const arr=[]; snap.forEach(s=>{if(s.key!==me) arr.push(s.key);});
    document.getElementById("typingDiv").textContent=arr.length?arr.join(", ")+" is typing...":"";
  });
}

// --- My Chats ---
function openChats(){
  document.getElementById("chatsModal").style.display="flex";
  const clist=document.getElementById("chatList");
  clist.innerHTML="";
  db.ref("users/"+me+"/myChats").get().then(s=>{
    s.forEach(chat=>{
      const b=document.createElement("button");
      b.textContent=chat.val();
      b.onclick=()=>{currentChat=chat.key; chatDiv.innerHTML=""; listenMsgs(); listenTyping(); cls('chatsModal');};
      clist.appendChild(b);
    });
  });
}

// --- Utilities ---
function cls(id){document.getElementById(id).style.display="none";}
function opn(id){document.getElementById(id).style.display="flex";}
</script>

</body>
</html>
