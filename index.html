<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>HyphonChat</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
:root{--bg-dark:#111;--text-dark:#eee;--bg-light:#f5f5f5;--text-light:#111;}
body{font-family:'Inter',sans-serif;margin:0;padding:0;background:var(--bg-dark);color:var(--text-dark);}
#startup,#chatUI{position:fixed;top:0;left:0;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;background:var(--bg-dark);z-index:10;}
#chatUI{display:none;flex-direction:column;padding:20px;box-sizing:border-box;}
#chatContainer{display:flex;flex-direction:column;width:100%;max-width:900px;flex:1;}
#chat{border:1px solid #444;padding:10px;height:400px;overflow-y:auto;border-radius:12px;background:#222;flex:1;display:none;flex-direction:column;}
textarea{width:100%;max-width:80%;height:50px;padding:10px;border-radius:8px;border:1px solid #555;margin-top:10px;resize:none;display:none;}
button{padding:10px 15px;border:none;border-radius:8px;margin-left:5px;cursor:pointer;}
.userBubble{padding:8px 12px;border-radius:15px;margin:2px 0;max-width:70%;word-wrap:break-word;align-self:flex-end;color:#fff;font-weight:500;position:relative;}
.friendBubble{padding:8px 12px;border-radius:15px;margin:2px 0;max-width:70%;word-wrap:break-word;align-self:flex-start;color:#fff;font-weight:500;position:relative;}
.joinMsg{color:#aaa;text-align:center;font-style:italic;margin:5px 0;}
.timestamp{font-size:10px;color:#ccc;margin-left:5px;}
#toggleMode{position:absolute;top:10px;right:10px;padding:5px 10px;border-radius:6px;}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);justify-content:center;align-items:center;z-index:50;}
.modalContent{background:#222;color:#fff;padding:20px;border-radius:12px;text-align:center;min-width:250px;}
.modalContent input{padding:8px;margin:8px;border-radius:6px;border:none;}
.modalContent button{margin-top:5px;padding:8px 12px;}
.editDelete{position:absolute;top:-5px;right:-5px;display:none;gap:4px;}
.editDelete button{padding:2px 5px;font-size:12px;border-radius:4px;}
.typingIndicator{font-style:italic;color:#aaa;font-size:12px;margin:3px 0;}
.usernameLabel{font-weight:bold;margin-top:8px;margin-bottom:2px;}
.friendsMenu{display:none;flex-direction:column;gap:5px;margin-top:5px;}
</style>
</head>
<body>

<div id="startup">
  <h1>Welcome to HyphonChat!</h1>
  <div>
    <button id="makeAccountBtn">Make Account</button>
    <button id="openAccountBtn">Open Account</button>
  </div>
</div>

<div id="chatUI">
  <button id="toggleMode" onclick="toggleMode()">Toggle Light/Dark</button>
  <div id="chatContainer">
    <div style="margin-bottom:10px;" id="topButtons">
      <button onclick="openAccountModalClean()">Account</button>
      <button onclick="showNewChat()">New Chat</button>
      <button onclick="leaveChat()">Leave Chat</button>
      <button onclick="toggleFriendsMenu()">Friends</button>
      <div id="friendsMenu" class="friendsMenu">
        <button onclick="openAddFriendModal()">Add Friend</button>
        <button onclick="openFriendRequests()">Friend Requests</button>
        <button onclick="openDMs()">DMs</button>
      </div>
    </div>
    <div id="chat"></div>
    <div id="typingDiv" class="typingIndicator"></div>
    <textarea id="msg" placeholder="Type a message..."></textarea>
    <button id="sendBtn" onclick="sendMessage()">Send</button>
  </div>
</div>

<!-- Modals -->
<div id="modal" class="modal"><div class="modalContent"><div id="modalText"></div><button onclick="closeModal()">X</button></div></div>
<div id="accountModal" class="modal"><div class="modalContent"><div id="accountText"></div>
<input id="accountInput" placeholder="Enter name"/>
<input id="accountPassword" type="password" placeholder="Password (optional)"/>
<div id="accountExtras"></div>
<button id="submitAccountBtn">Submit</button>
<button onclick="closeAccountModal()">X</button>
</div></div>
<div id="newChatModal" class="modal"><div class="modalContent">
<button onclick="createChatUI()">Create Chat</button>
<button onclick="joinChatUI()">Join Chat</button>
<button onclick="closeNewChat()">X</button>
</div></div>
<div id="createChatModal" class="modal"><div class="modalContent">
<div>Create Chat</div><input id="createChatName" placeholder="Chat name"/><button onclick="submitCreateChat()">Create</button><button onclick="closeCreateChat()">X</button>
</div></div>
<div id="joinChatModal" class="modal"><div class="modalContent">
<div>Join Chat</div><input id="joinChatCode" placeholder="Chat code"/><button onclick="submitJoinChat()">Join</button><button onclick="closeJoinChat()">X</button>
</div></div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script>
// --- Firebase Setup ---
const firebaseConfig={apiKey:"AIzaSyCSh6K8e_CAswGyYuIvgMVKZ3T8b5gGKFU",authDomain:"hyphonchat.firebaseapp.com",databaseURL:"https://hyphonchat-default-rtdb.firebaseio.com",projectId:"hyphonchat",storageBucket:"hyphonchat.firebasestorage.app",messagingSenderId:"172774813412",appId:"1:172774813412:web:8d307b6a170bf270cfc6f1"};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

// --- Globals ---
let myName="", myColor="#1abc9c";
let currentChat=null;
const chatDiv=document.getElementById("chat");
const typingDiv=document.getElementById("typingDiv");
const maxMessages=40;
const standardColors=["#1abc9c","#3498db","#e74c3c","#f1c40f","#9b59b6"];
const secretColors=["linear-gradient(45deg,#ff6ec4,#7873f5)","linear-gradient(45deg,#00f260,#0575e6)","linear-gradient(45deg,#ff512f,#dd2476)"];
let lastUser=null,lastTime=0;
let chatListener=null,typingTimeout;

// --- Startup Buttons ---
document.getElementById("makeAccountBtn").addEventListener("click",()=>{document.getElementById("accountText").innerText="Create Account";document.getElementById("accountModal").style.display="flex";});
document.getElementById("openAccountBtn").addEventListener("click",()=>{document.getElementById("accountText").innerText="Open Account";document.getElementById("accountModal").style.display="flex";});
document.getElementById("submitAccountBtn").addEventListener("click",submitAccount);

// --- Mode ---
function toggleMode(){const dark=document.body.style.background!=="#111";document.body.style.background=dark?"#111":"#f5f5f5";document.body.style.color=dark?"#eee":"#111";chatDiv.style.background=dark?"#222":"#ddd";}

// --- Account ---
function submitAccount(){
  const name=document.getElementById("accountInput").value.trim();
  const pass=document.getElementById("accountPassword").value||"";
  const creating=document.getElementById("accountText").innerText==="Create Account";
  if(!name){alert("Enter name");return;}
  db.ref("users/"+name).get().then(snap=>{
    if(creating){
      if(snap.exists()){alert("Name taken");return;}
      myName=name; myColor=standardColors[0];
      db.ref("users/"+name).set({password:pass,color:myColor,myChats:{},friends:{},requests:{},dms:{}});
      startChatUI();
    } else {
      if(!snap.exists()){alert("User not found");return;}
      const stored=snap.val();
      if(stored.password&&stored.password!==pass){alert("Wrong password");return;}
      myName=name; myColor=stored.color||standardColors[0];
      startChatUI();
    }
    closeAccountModal();
  });
}
function openAccountModalClean(){
  document.getElementById("accountText").innerText="Account Settings";
  document.getElementById("accountModal").style.display="flex";
  document.getElementById("accountExtras").innerHTML="";
  if(myName==="Nether"){
    const addBtn=document.createElement("button");
    addBtn.textContent="Add Secret Color";
    addBtn.onclick=()=>{const c=prompt("Enter secret gradient CSS:");if(c){secretColors.push(c);alert("Added!");}};
    document.getElementById("accountExtras").appendChild(addBtn);
  }
}
function closeAccountModal(){document.getElementById("accountModal").style.display="none";}

// --- Chat UI ---
function startChatUI(){document.getElementById("startup").style.display="none";document.getElementById("chatUI").style.display="flex";}
function showNewChat(){document.getElementById("newChatModal").style.display="flex";}
function closeNewChat(){document.getElementById("newChatModal").style.display="none";}
function createChatUI(){document.getElementById("createChatModal").style.display="flex";}
function joinChatUI(){document.getElementById("joinChatModal").style.display="flex";}
function closeCreateChat(){document.getElementById("createChatModal").style.display="none";}
function closeJoinChat(){document.getElementById("joinChatModal").style.display="none";}

// --- Create/Join Chat ---
function submitCreateChat(){
  const name=document.getElementById("createChatName").value.trim();if(!name)return;
  const code=Math.floor(10000+Math.random()*89999);
  db.ref(`chats/${code}`).set({name,members:{[myName]:true}});
  db.ref(`users/${myName}/myChats/${code}`).set(name);
  joinChat(code);closeCreateChat();
  alert(`Chat code: ${code}`);
}
function submitJoinChat(){
  const code=document.getElementById("joinChatCode").value.trim();if(!code)return;
  db.ref(`chats/${code}`).get().then(snap=>{
    if(!snap.exists()){alert("Chat not found");return;}
    db.ref(`users/${myName}/myChats/${code}`).set(snap.val().name);
    joinChat(code);closeJoinChat();
  });
}

// --- Join / Leave Chat ---
function joinChat(code){
  if(chatListener)chatListener.off();
  currentChat=code;
  chatDiv.style.display="flex";
  document.getElementById("msg").style.display="block";
  document.getElementById("sendBtn").style.display="inline-block";
  chatDiv.innerHTML="";
  db.ref(`messages/${currentChat}`).push({text:`${myName} joined the chat (${code})`,user:"system",timestamp:Date.now()});
  chatListener=db.ref(`messages/${currentChat}`);
  chatListener.on("child_added",snap=>{renderMessage(snap.key,snap.val());pruneMessages();});
  listenTyping();
}
function leaveChat(){
  if(!currentChat)return;
  db.ref("chats/"+currentChat+"/members/"+myName).remove();
  currentChat=null; chatDiv.innerHTML=""; chatDiv.style.display="none";document.getElementById("msg").style.display="none";document.getElementById("sendBtn").style.display="none";
}

// --- Render Messages ---
function renderMessage(key,data){
  const div=document.createElement("div");
  const isMe=data.user===myName;
  if(data.user==="system"){div.textContent=data.text;div.className="joinMsg";chatDiv.appendChild(div);return;}
  const now=Date.now();
  const showUsername=!lastUser||lastUser!==data.user||now-lastTime>60000;
  if(showUsername){
    const label=document.createElement("div");label.className="usernameLabel";label.textContent=data.user;div.appendChild(label);
    lastUser=data.user; lastTime=now;
  }
  const bubble=document.createElement("div");
  bubble.className=isMe?"userBubble":"friendBubble";
  bubble.textContent=data.text;
  bubble.style.background=data.color||"#555";
  if(isMe){
    const btnDiv=document.createElement("div");btnDiv.className="editDelete";
    btnDiv.innerHTML=`<button onclick="editMsg('${key}')">Edit</button><button onclick="deleteMsg('${key}')">Del</button>`;
    bubble.appendChild(btnDiv);
    bubble.addEventListener("mouseenter",()=>{setTimeout(()=>{btnDiv.style.display="flex";},2000);});
    bubble.addEventListener("mouseleave",()=>{btnDiv.style.display="none";});
  }
  const ts=document.createElement("span");ts.className="timestamp";ts.textContent=formatTime(data.timestamp);bubble.appendChild(ts);
  div.appendChild(bubble);
  chatDiv.appendChild(div);
  chatDiv.scrollTop=chatDiv.scrollHeight;
}
function sendMessage(){
  if(!currentChat)return;
  const text=document.getElementById("msg").value.trim();if(!text)return;
  db.ref(`messages/${currentChat}`).push({text,user:myName,color:myColor,timestamp:Date.now()});
  document.getElementById("msg").value="";
}
function deleteMsg(key){if(!key||!currentChat)return;db.ref(`messages/${currentChat}/${key}`).remove();}
function editMsg(key){if(!key||!currentChat)return;const t=prompt("Edit your message:");if(t)db.ref(`messages/${currentChat}/${key}/text`).set(t);}
function pruneMessages(){db.ref("messages/"+currentChat).get().then(snap=>{const msgs=Object.entries(snap.val()||{});if(msgs.length>maxMessages){msgs.slice(0,msgs.length-maxMessages).forEach(m=>db.ref(`messages/${currentChat}/${m[0]}`).remove());}});}
function formatTime(ts){const d=new Date(ts);let h=d.getHours(),m=d.getMinutes();if(h===0)h=12;if(h>12)h-=12;m=m<10?"0"+m:m;return h+":"+m;}
document.getElementById("msg").addEventListener("input",()=>{
  if(!currentChat)return;
  db.ref(`typing/${currentChat}/${myName}`).set(true);
  clearTimeout(typingTimeout);
  typingTimeout=setTimeout(()=>{db.ref(`typing/${currentChat}/${myName}`).remove();},1500);
});
function listenTyping(){db.ref(`typing/${currentChat}`).on("value",snap=>{const arr=[];snap.forEach(s=>{if(s.key!==myName)arr.push(s.key);});typingDiv.textContent=arr.length?arr.join(", ")+" is typing...":"";});

// --- Friends / Requests / DMs ---
function toggleFriendsMenu(){const f=document.getElementById("friendsMenu");f.style.display=f.style.display==="flex"?"none":"flex";}
function openAddFriendModal(){const f=prompt("Enter friend's username:");if(!f)return;if(f===myName){alert("Cannot add yourself.");return;}db.ref(`users/${f}/requests/${myName}`).set(true);alert("Friend request sent!");}
function openFriendRequests(){db.ref(`users/${myName}/requests`).get().then(snap=>{if(!snap.exists()){alert("No friend requests");return;}const reqs=Object.keys(snap.val());const sel=prompt("Requests: "+reqs.join(", ")+"\nType name to accept or leave blank:");if(sel&&reqs.includes(sel)){db.ref(`users/${myName}/friends/${sel}`).set(true);db.ref(`users/${sel}/friends/${myName}`).set(true);db.ref(`users/${myName}/requests/${sel}`).remove();alert("Friend added!");}});}
function openDMs(){db.ref(`users/${myName}/friends`).get().then(snap=>{if(!snap.exists()){alert("No friends");return;}const friends=Object.keys(snap.val());const sel=prompt("Friends: "+friends.join(", ")+"\nType name to DM:");if(sel&&friends.includes(sel)){const code=Math.floor(10000+Math.random()*89999);db.ref(`users/${myName}/dms/${code}`).set(sel);db.ref(`users/${sel}/dms/${code}`).set(myName);joinChat(code);}}}

// --- Modals ---
function closeModal(){document.getElementById("modal").style.display="none";}
</script>
</body>
</html>
