<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>HyphonChat</title>
<style>
body {margin:0;font-family:sans-serif;background:#222;color:#fff;display:flex;flex-direction:column;height:100vh;}
header {background:#333;padding:10px;display:flex;justify-content:space-between;align-items:center;}
header button{margin:0 5px;}
#chat {flex:1;overflow-y:auto;padding:10px;display:flex;flex-direction:column;}
.usernameLabel {font-size:12px;color:#ccc;margin:4px;}
.userBubble,.friendBubble {max-width:60%;padding:8px 12px;border-radius:16px;margin:2px 0;word-wrap:break-word;display:inline-block;}
.userBubble {align-self:flex-end;background:#1abc9c;color:#fff;border-bottom-right-radius:0;}
.friendBubble {align-self:flex-start;background:#444;color:#fff;border-bottom-left-radius:0;}
.joinMsg {text-align:center;color:#aaa;font-size:12px;margin:6px 0;}
.timestamp {font-size:10px;color:#bbb;margin:0 6px;}
.editDelete{display:none;gap:4px;}
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;}
.modalContent{background:#333;padding:20px;border-radius:12px;max-height:80%;overflow:auto;}
</style>
</head>
<body>
<header>
  <div>
    <button onclick="openLogin()">Log In</button>
    <button onclick="openSignup()">Sign Up For Free</button>
  </div>
  <div>
    <button onclick="openMyChats()">My Chats</button>
    <button onclick="openAccount()">Account</button>
  </div>
</header>

<div id="chat"></div>

<div style="display:flex;padding:10px;">
  <input id="msg" placeholder="Type..." style="flex:1;padding:8px;border-radius:8px;border:none;"/>
  <button onclick="sendMsg()">Send</button>
</div>

<!-- My Chats Modal -->
<div class="modal" id="myChatsModal"><div class="modalContent"><h3>My Chats</h3><div id="myChatsList"></div><button onclick="closeMyChats()">Close</button></div></div>

<!-- Account Modal -->
<div class="modal" id="accountModal"><div class="modalContent"><h3>Account</h3><div id="accountText"></div><button onclick="closeAccount()">Close</button></div></div>

<!-- Friend Requests -->
<div class="modal" id="friendRequestsModal"><div class="modalContent"><h3>Friend Requests</h3><div id="friendRequestsList"></div><button onclick="closeFriendRequests()">Close</button></div></div>

<!-- DMs -->
<div class="modal" id="dmsModal"><div class="modalContent"><h3>DMs</h3><div id="dmsList"></div><button onclick="closeDMs()">Close</button></div></div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script>
const firebaseConfig={apiKey:"fake",authDomain:"fake",databaseURL:"https://fake.firebaseio.com",projectId:"fake"};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

let myName="";let myColor="#1abc9c";let currentChat=null;let chatListener=null;let lastUser=null;let lastTime=0;

// --- UI helpers ---
function openLogin(){alert("Login modal (placeholder)");}
function openSignup(){alert("Signup modal (placeholder)");}

// --- My Chats ---
function openMyChats(){
  const list=document.getElementById("myChatsList");list.innerHTML="";
  db.ref("users/"+myName+"/myChats").once("value").then(snap=>{
    snap.forEach(c=>{
      const div=document.createElement("div");
      div.textContent=c.val()+" ";
      const join=document.createElement("button");join.textContent="Open";join.onclick=()=>{joinChat(c.key);closeMyChats();};
      const leave=document.createElement("button");leave.textContent="Leave";leave.onclick=()=>{if(confirm("Leave chat?")){db.ref("users/"+myName+"/myChats/"+c.key).remove();if(currentChat===c.key){chat.innerHTML="";currentChat=null;}};};
      div.appendChild(join);div.appendChild(leave);list.appendChild(div);
    });
  });
  document.getElementById("myChatsModal").style.display="flex";
}
function closeMyChats(){document.getElementById("myChatsModal").style.display="none";}

// --- Account ---
function openAccount(){
  const html=`
    Username: ${myName}<br/>
    <input id="changeName" placeholder="Change username"/><br/>
    Colors:<br/>
    ${["#1abc9c","#3498db","#9b59b6","#e74c3c","#f1c40f","#2ecc71"].map(c=>`<button onclick="setMyColor('${c}')" style="background:${c};width:24px;height:24px;border:none;margin:2px;"></button>`).join("")}
    <div style="margin-top:10px;">
      <input id="friendInput" placeholder="Add Friend"/>
      <button onclick="sendFriendRequest()">Add</button>
    </div>
    <button onclick="openFriendRequests()">Friend Requests</button>
    <button onclick="openDMs()">DMs</button>
  `;
  document.getElementById("accountText").innerHTML=html;
  document.getElementById("accountModal").style.display="flex";
}
function closeAccount(){document.getElementById("accountModal").style.display="none";}
function setMyColor(c){myColor=c;db.ref("users/"+myName+"/color").set(c);}
function sendFriendRequest(){const t=document.getElementById("friendInput").value.trim();if(!t||t===myName)return;db.ref("users/"+t+"/requests/"+myName).set(true);alert("Request sent");}

// --- Friends ---
function openFriendRequests(){
  const list=document.getElementById("friendRequestsList");list.innerHTML="";
  db.ref("users/"+myName+"/requests").once("value").then(snap=>{
    snap.forEach(r=>{
      const div=document.createElement("div");div.textContent=r.key+" ";
      const a=document.createElement("button");a.textContent="Accept";
      a.onclick=()=>{db.ref("users/"+myName+"/friends/"+r.key).set(true);db.ref("users/"+r.key+"/friends/"+myName).set(true);db.ref("users/"+myName+"/requests/"+r.key).remove();openFriendRequests();};
      const d=document.createElement("button");d.textContent="Decline";
      d.onclick=()=>{db.ref("users/"+myName+"/requests/"+r.key).remove();openFriendRequests();};
      div.appendChild(a);div.appendChild(d);list.appendChild(div);
    });
  });
  document.getElementById("friendRequestsModal").style.display="flex";
}
function closeFriendRequests(){document.getElementById("friendRequestsModal").style.display="none";}
function openDMs(){
  const list=document.getElementById("dmsList");list.innerHTML="";
  db.ref("users/"+myName+"/friends").once("value").then(snap=>{
    snap.forEach(f=>{
      const btn=document.createElement("button");btn.textContent=f.key;
      btn.onclick=()=>{openDM(f.key);closeDMs();};
      list.appendChild(btn);
    });
  });
  document.getElementById("dmsModal").style.display="flex";
}
function closeDMs(){document.getElementById("dmsModal").style.display="none";}
function openDM(friend){
  const dmCode=[myName,friend].sort().join("_");
  db.ref("users/"+myName+"/myChats/"+dmCode).set("DM with "+friend);
  db.ref("users/"+friend+"/myChats/"+dmCode).set("DM with "+myName);
  joinChat(dmCode,true);
}

// --- Chat ---
function joinChat(code,isDM){
  currentChat=code;chat.innerHTML="";
  if(chatListener)db.ref("messages/"+code).off("child_added",chatListener);
  chatListener=db.ref("messages/"+code).on("child_added",snap=>{
    const d=snap.val();addBubble(d.user,d.text,d.color,d.user===myName,d.system,snap.key,d.timestamp);
  });
  if(!isDM){db.ref("users/"+myName+"/myChats/"+code).set("Chat "+code);}
}
function sendMsg(){
  if(!currentChat)return;
  const val=document.getElementById("msg").value.trim();if(!val)return;
  db.ref("messages/"+currentChat).push({user:myName,text:val,color:myColor,timestamp:Date.now()});
  document.getElementById("msg").value="";
}
function addBubble(user,text,color,isMe,system,key,timestamp){
  const cont=document.createElement("div");
  if(system){cont.className="joinMsg";cont.textContent=text;}
  else{
    if(user!==lastUser||(timestamp-lastTime)>60000){const l=document.createElement("div");l.className="usernameLabel";l.textContent=user;cont.appendChild(l);}
    lastUser=user;lastTime=timestamp;
    const b=document.createElement("div");b.className=isMe?"userBubble":"friendBubble";
    if(color){b.style.background=color;}
    b.textContent=text;cont.appendChild(b);
    const t=document.createElement("span");t.className="timestamp";t.textContent=new Date(timestamp).toLocaleTimeString();cont.appendChild(t);
  }
  chat.appendChild(cont);chat.scrollTop=chat.scrollHeight;
}
</script>
</body>
</html>
